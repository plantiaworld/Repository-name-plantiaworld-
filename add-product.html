<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ë¬¼ ë“±ë¡ - PlantiaWorld</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f9fafb; }
        .input-focus:focus { outline: none; border-color: #2e8b57; ring: 2px; border: 2px solid #2e8b57; }
        .btn-submit { background: linear-gradient(135deg, #2e8b57 0%, #32cd32 100%); transition: all 0.3s; }
        .btn-submit:disabled { background: #ccc; cursor: not-allowed; }
        .preview-item { position: relative; width: 100px; height: 100px; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; border: 1px solid #e5e7eb; }
        .delete-btn { position: absolute; top: -5px; right: -5px; background: rgba(0,0,0,0.7); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 2px solid white; z-index: 10; }
    </style>
</head>
<body>

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex items-center">
            <button onclick="location.href='index.html'" class="text-gray-600 hover:text-green-700 mr-4">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            <h1 class="text-xl font-bold text-gray-800">ì‹ë¬¼ ë‚˜ëˆ”/íŒë§¤ ë“±ë¡</h1>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-2xl">
        <form id="productForm" class="space-y-6 bg-white p-6 md:p-8 rounded-3xl shadow-sm">
            
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-3">ì‚¬ì§„ ë“±ë¡ (ìµœëŒ€ 8ì¥)</label>
                <div class="flex flex-wrap gap-3">
                    <label class="w-24 h-24 border-2 border-dashed border-gray-300 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 shrink-0">
                        <i class="fas fa-camera text-gray-400 text-xl mb-1"></i>
                        <span id="imageCountText" class="text-[10px] text-gray-400">0/8</span>
                        <input type="file" id="imageInput" accept="image/*" class="hidden" multiple onchange="handleImageUpload(this)">
                    </label>
                    <div id="imagePreviewList" class="flex flex-wrap gap-3"></div>
                </div>
            </div>

            <div>
                <label for="title" class="block text-sm font-bold text-gray-700 mb-2">ê¸€ ì œëª©</label>
                <input type="text" id="title" required placeholder="ì‹ë¬¼ ì´ë¦„ì´ë‚˜ íŠ¹ì§•ì„ ì ì–´ì£¼ì„¸ìš”" 
                       class="w-full px-4 py-3 rounded-xl border border-gray-200 input-focus">
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">ì¹´í…Œê³ ë¦¬</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <label class="cursor-pointer">
                        <input type="radio" name="category" value="ê´€ì—½ì‹ë¬¼" class="hidden peer" checked>
                        <div class="py-2 text-center border border-gray-200 rounded-lg peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-600 text-sm font-medium">ê´€ì—½ì‹ë¬¼</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="category" value="ë‹¤ìœ¡ì‹ë¬¼" class="hidden peer">
                        <div class="py-2 text-center border border-gray-200 rounded-lg peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-600 text-sm font-medium">ë‹¤ìœ¡ì‹ë¬¼</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="category" value="í™”ë¶„/í™" class="hidden peer">
                        <div class="py-2 text-center border border-gray-200 rounded-lg peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-600 text-sm font-medium">í™”ë¶„/ìš©í’ˆ</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="category" value="ì •ë³´ê³µìœ " class="hidden peer">
                        <div class="py-2 text-center border border-gray-200 rounded-lg peer-checked:bg-green-50 peer-checked:border-green-500 peer-checked:text-green-600 text-sm font-medium">ì •ë³´ê³µìœ </div>
                    </label>
                </div>
            </div>

            <div>
                <label for="price" class="block text-sm font-bold text-gray-700 mb-2">ê°€ê²© (ì›)</label>
                <div class="relative">
                    <input type="number" id="price" placeholder="ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”" 
                           class="w-full px-4 py-3 rounded-xl border border-gray-200 input-focus">
                    <div class="absolute right-4 top-3 flex items-center">
                        <input type="checkbox" id="isFree" onchange="togglePrice(this)" class="mr-2 h-4 w-4 rounded border-gray-300 text-green-600">
                        <label for="isFree" class="text-sm text-gray-500">ë‚˜ëˆ”</label>
                    </div>
                </div>
            </div>

            <div>
                <label for="description" class="block text-sm font-bold text-gray-700 mb-2">ìì„¸í•œ ì„¤ëª…</label>
                <textarea id="description" rows="5" required placeholder="ì‹ë¬¼ì˜ ìƒíƒœ ë“± ì •ë³´ë¥¼ ì ì–´ì£¼ì„¸ìš”." 
                          class="w-full px-4 py-3 rounded-xl border border-gray-200 input-focus"></textarea>
            </div>

            <div>
                <label for="location" class="block text-sm font-bold text-gray-700 mb-2">ê±°ë˜ í¬ë§ ì§€ì—­</label>
                <input type="text" id="location" required placeholder="ì˜ˆ: ë¶€ì‚° í•´ìš´ëŒ€êµ¬ ìš°ë™" 
                       class="w-full px-4 py-3 rounded-xl border border-gray-200 input-focus">
            </div>

            <div class="pt-4">
                <button type="submit" id="submitBtn" class="btn-submit w-full py-4 text-white font-bold rounded-xl shadow-lg text-lg">
                    ì‘ì„± ì™„ë£Œí•˜ê¸°
                </button>
            </div>
        </form>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAW_z3hoI9SZ1-hoxKVYBKs7rbdo8n6wdc",
            authDomain: "plantiaworld.firebaseapp.com",
            projectId: "plantiaworld",
            storageBucket: "plantiaworld.appspot.com",
            messagingSenderId: "18112813073",
            appId: "1:18112813073:web:7247046c038a3831db79b0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let uploadedImages = [];

        // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.");
                location.href = "login.html";
            }
            currentUser = user;
        });

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (ì‚¬ìš©ìë‹˜ ì½”ë“œ ìœ ì§€ ë° ë³´ì™„)
        window.handleImageUpload = function(input) {
            const files = Array.from(input.files);
            if (uploadedImages.length + files.length > 8) {
                alert("ì‚¬ì§„ì€ ìµœëŒ€ 8ì¥ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const max_size = 600; // ì„œë²„ ë¶€í•˜ë¥¼ ì¤„ì´ê¸° ìœ„í•´ ì¡°ê¸ˆ ë” ì¶•ì†Œ

                        if (width > height) {
                            if (width > max_size) { height *= max_size / width; width = max_size; }
                        } else {
                            if (height > max_size) { width *= max_size / height; height = max_size; }
                        }

                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const compressedData = canvas.toDataURL('image/jpeg', 0.6); // í’ˆì§ˆ 0.6
                        uploadedImages.push(compressedData);
                        updatePreview();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        function updatePreview() {
            const listElement = document.getElementById('imagePreviewList');
            listElement.innerHTML = uploadedImages.map((src, i) => `
                <div class="preview-item">
                    <img src="${src}">
                    <button type="button" onclick="removeImage(${i})" class="delete-btn"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
            document.getElementById('imageCountText').innerText = `${uploadedImages.length}/8`;
        }

        window.removeImage = function(index) {
            uploadedImages.splice(index, 1);
            updatePreview();
        };

        window.togglePrice = function(checkbox) {
            const priceInput = document.getElementById('price');
            priceInput.value = checkbox.checked ? 0 : "";
            priceInput.readOnly = checkbox.checked;
        };

        // í¼ ì œì¶œ (Firebase ì €ì¥)
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');

            if (uploadedImages.length === 0) {
                alert("ì‚¬ì§„ì„ í•œ ì¥ ì´ìƒ ì˜¬ë ¤ì£¼ì„¸ìš”.");
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerText = "ë“±ë¡ ì¤‘...";

            try {
                await addDoc(collection(db, "products"), {
                    title: document.getElementById('title').value,
                    category: document.querySelector('input[name="category"]:checked').value,
                    price: Number(document.getElementById('price').value),
                    description: document.getElementById('description').value,
                    location: document.getElementById('location').value,
                    images: uploadedImages, // Base64ë¡œ ì €ì¥
                    sellerId: currentUser.uid,
                    sellerName: currentUser.displayName || currentUser.email.split('@')[0],
                    createdAt: serverTimestamp(),
                    status: "íŒë§¤ì¤‘"
                });

                alert("ğŸŒ± ì‹ë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                location.href = "index.html";
            } catch (err) {
                console.error("ë“±ë¡ ì—ëŸ¬:", err);
                alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
                submitBtn.disabled = false;
                submitBtn.innerText = "ì‘ì„± ì™„ë£Œí•˜ê¸°";
            }
        });
    </script>
</body>
</html>