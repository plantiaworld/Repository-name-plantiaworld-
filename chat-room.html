<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ…ë°© - PlantiaWorld</title>
    <!-- âœ… PWA ì„¤ì • -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#10b981">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="í”Œëœí‹°ì•„ì›”ë“œ">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <!-- âœ… PWA ì„¤ì • ë -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f1f5f9; height: 100vh; display: flex; flex-direction: column; }
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        .message-bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.5; position: relative; }
        .my-message { background-color: #16a34a; color: white; border-bottom-right-radius: 4px; align-self: flex-end; }
        .other-message { background-color: white; color: #334155; border-bottom-left-radius: 4px; align-self: flex-start; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chat-input-area { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .image-message { max-width: 200px; border-radius: 12px; margin-top: 4px; cursor: pointer; }
        .message-menu { position: absolute; top: 8px; right: 8px; opacity: 0; transition: opacity 0.2s; }
        .message-bubble:hover .message-menu { opacity: 1; }
        /* âœ… ì‚­ì œ ë²„íŠ¼ */
        .delete-msg-btn {
            background: none;
            border: none;
            color: #d1d5db;
            font-size: 11px;
            cursor: pointer;
            padding: 0 2px 20px;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s;
            flex-shrink: 0;
        }
        .flex:hover .delete-msg-btn { opacity: 1; }
        .delete-msg-btn:hover { color: #ef4444 !important; }
        textarea { max-height: 120px; overflow-y: auto; }
        
        /* ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 140px;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #334155;
            transition: background 0.2s;
        }
        .dropdown-item:hover { background: #f1f5f9; }
        .dropdown-item.danger { color: #dc2626; }

        /* ===== ê±°ë˜ ì˜ˆì•½ ëª¨ë‹¬ ===== */
        .deal-modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 2000;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .deal-modal {
            background: #fff;
            border-radius: 24px 24px 0 0;
            padding: 28px 24px 36px;
            width: 100%; max-width: 480px;
            animation: slideUp 0.25s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to   { transform: translateY(0);    opacity: 1; }
        }
        .deal-modal h3 {
            font-size: 17px; font-weight: 700; color: #111827;
            margin-bottom: 6px;
        }
        .deal-modal .sub {
            font-size: 13px; color: #6b7280; margin-bottom: 20px;
        }
        .deal-status-row {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        .deal-status-btn {
            flex: 1; padding: 14px 8px;
            border: 2px solid #e5e7eb; border-radius: 14px;
            background: #fff; cursor: pointer;
            text-align: center; font-size: 13px; font-weight: 600;
            color: #374151; transition: all 0.2s;
            font-family: 'Noto Sans KR', sans-serif;
        }
        .deal-status-btn .icon { font-size: 22px; display: block; margin-bottom: 6px; }
        .deal-status-btn:hover { border-color: #6ee7b7; background: #f0fdf4; }
        .deal-status-btn.selected { border-color: #10b981; background: #ecfdf5; color: #065f46; }
        .deal-status-btn.selected-orange { border-color: #f97316; background: #fff7ed; color: #9a3412; }
        .deal-status-btn.selected-red    { border-color: #ef4444; background: #fef2f2; color: #991b1b; }
        .deal-confirm-btn {
            width: 100%; padding: 15px;
            border: none; border-radius: 14px;
            font-size: 16px; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
            font-family: 'Noto Sans KR', sans-serif;
        }
        .deal-confirm-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff; box-shadow: 0 4px 14px rgba(16,185,129,0.35);
        }
        .deal-confirm-btn.inactive {
            background: #f3f4f6; color: #9ca3af; cursor: not-allowed;
        }
        /* ë²„íŠ¼ ìœ„ í˜„ì¬ ìƒíƒœ ë°°ì§€ */
        #dealBtn.status-reserved {
            background: #fff7ed; color: #ea580c;
            border-color: #fed7aa;
        }
        #dealBtn.status-sold {
            background: #fef2f2; color: #dc2626;
            border-color: #fecaca;
        }
    </style>
</head>
<body class="bg-gray-50">

    <header class="bg-white border-b border-gray-100 px-4 py-3 flex items-center sticky top-0 z-10">
        <button onclick="history.back()" class="mr-3 text-gray-500"><i class="fas fa-chevron-left text-xl"></i></button>
        <div class="flex items-center flex-1">
            <img id="otherUserImg" src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%20viewBox%3D%220%200%2040%2040%22%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2220%22%20r%3D%2220%22%20fill%3D%22%2310b981%22%2F%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2215%22%20r%3D%228%22%20fill%3D%22white%22%2F%3E%3Cellipse%20cx%3D%2220%22%20cy%3D%2235%22%20rx%3D%2212%22%20ry%3D%228%22%20fill%3D%22white%22%2F%3E%3C%2Fsvg%3E" class="w-10 h-10 rounded-full border border-gray-100">
            <div class="ml-3">
                <h3 id="otherUserName" class="font-bold text-gray-800">ë¡œë”© ì¤‘...</h3>
                <p class="text-[10px] text-green-500 flex items-center"><span id="onlineStatus" class="w-2 h-2 bg-green-500 rounded-full mr-1"></span> <span id="statusText">ì‘ë‹µ ë¹ ë¦„</span></p>
            </div>
        </div>
        <div class="relative">
            <button id="menuBtn" class="text-gray-400 hover:text-gray-600"><i class="fas fa-ellipsis-v"></i></button>
            <div id="dropdownMenu" class="dropdown-menu">
                <div class="dropdown-item" onclick="muteChat()"><i class="fas fa-volume-mute mr-2"></i>ì•Œë¦¼ ë„ê¸°</div>
                <div class="dropdown-item" onclick="searchChat()"><i class="fas fa-search mr-2"></i>ëŒ€í™” ê²€ìƒ‰</div>
                <div class="dropdown-item danger" onclick="leaveChat()"><i class="fas fa-sign-out-alt mr-2"></i>ì±„íŒ…ë°© ë‚˜ê°€ê¸°</div>
                <div class="dropdown-item danger" onclick="reportChat()"><i class="fas fa-flag mr-2"></i>ì‹ ê³ í•˜ê¸°</div>
            </div>
        </div>
    </header>

    <div class="bg-white px-4 py-2 border-b border-gray-100 flex items-center justify-between">
        <div class="flex items-center">
            <img id="productImg" src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%23e8f5e9%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-size%3D%2260%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3E%F0%9F%8C%BF%3C%2Ftext%3E%3C%2Fsvg%3E" class="w-12 h-12 rounded-lg object-cover">
            <div class="ml-3">
                <p id="productTitle" class="text-sm font-semibold text-gray-700">ë¡œë”© ì¤‘...</p>
                <p id="productPrice" class="text-xs font-bold text-gray-900">0ì›</p>
            </div>
        </div>
        <button id="dealBtn" class="bg-green-50 text-green-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-green-100 hover:bg-green-100 transition">ê±°ë˜ ì˜ˆì•½</button>
    </div>

    <!-- ===== ê±°ë˜ ì˜ˆì•½ ëª¨ë‹¬ ===== -->
    <div id="dealModal" class="deal-modal-overlay" style="display:none;" onclick="closeDealModal(event)">
        <div class="deal-modal" onclick="event.stopPropagation()">
            <h3>ğŸŒ¿ ê±°ë˜ ìƒíƒœ ë³€ê²½</h3>
            <p class="sub" id="dealProductName">ìƒí’ˆëª… ë¡œë”© ì¤‘...</p>

            <div class="deal-status-row">
                <button class="deal-status-btn" id="btnSelling" onclick="selectDealStatus('íŒë§¤ì¤‘')">
                    <span class="icon">ğŸŸ¢</span>íŒë§¤ì¤‘
                </button>
                <button class="deal-status-btn" id="btnReserved" onclick="selectDealStatus('ì˜ˆì•½ì¤‘')">
                    <span class="icon">ğŸŸ </span>ì˜ˆì•½ì¤‘
                </button>
                <button class="deal-status-btn" id="btnSold" onclick="selectDealStatus('íŒë§¤ì™„ë£Œ')">
                    <span class="icon">ğŸ”´</span>íŒë§¤ì™„ë£Œ
                </button>
            </div>

            <button id="dealConfirmBtn" class="deal-confirm-btn inactive" onclick="confirmDealStatus()">
                ë³€ê²½í•˜ê¸°
            </button>
        </div>
    </div>

    <div id="chatMessages" class="chat-container flex flex-col space-y-4 pb-24">
        <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>

    <div class="chat-input-area fixed bottom-0 left-0 right-0 p-4 border-t border-gray-100">
        <div class="max-w-4xl mx-auto flex items-end space-x-3">
            <div class="relative">
                <button id="attachBtn" class="mb-2 text-gray-400 hover:text-green-600 transition">
                    <i class="fas fa-plus-circle text-2xl"></i>
                </button>
                <input type="file" id="fileInput" accept="image/*" class="hidden">
            </div>
            <div class="flex-1 bg-gray-100 rounded-[1.5rem] px-4 py-2 flex items-center">
                <textarea id="messageInput" rows="1" class="w-full bg-transparent border-none focus:ring-0 text-sm resize-none py-1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
            <button id="sendBtn" class="mb-1 bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg shadow-green-200 active:scale-90 transition hover:bg-green-700">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div id="filePreview" class="max-w-4xl mx-auto mt-2 hidden">
            <!-- íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden items-center justify-center p-4">
        <div class="relative max-w-4xl max-h-full">
            <img id="modalImage" src="" class="max-w-full max-h-[80vh] rounded-lg">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-2xl bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Firebase v10 ëª¨ë“ˆ ë°©ì‹ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        // ============================================
        // Firebase v10 SDK Import
        // ============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            serverTimestamp,
            doc,
            getDoc,
            deleteDoc,
            updateDoc,
            increment,
            enableIndexedDbPersistence,
            arrayUnion
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { 
            getStorage, 
            ref, 
            uploadBytesResumable, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";
        import {
            getMessaging,
            getToken,
            onMessage,
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-messaging.js";

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // âš ï¸ VAPID í‚¤ ì„¤ì • (Firebase Consoleì—ì„œ ë°œê¸‰)
        //   ê²½ë¡œ: í”„ë¡œì íŠ¸ ì„¤ì • â†’ í´ë¼ìš°ë“œ ë©”ì‹œì§• â†’ ì›¹ êµ¬ì„±
        //         â†’ ì›¹ í‘¸ì‹œ ì¸ì¦ì„œ â†’ "í‚¤ ìŒ ìƒì„±" ë²„íŠ¼ í´ë¦­
        //         â†’ ìƒì„±ëœ í‚¤ ì „ì²´ ë³µì‚¬í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ê¸°
        const VAPID_KEY = 'BCzKbFzkoRHIX1qWuBOlZtTNDqm4DOnSW7OEiRfD2MnAcigf7HXHQkdZJpXpUnETP0t8azfP4UYwqEhqDM1pTDg';
        // âœ… ì„œë²„ í‚¤(ë ˆê±°ì‹œ)ëŠ” 2024ë…„ 7ì›” ì´í›„ ì‚¬ìš© ë¶ˆê°€.
        //    ì•Œë¦¼ ë°œì†¡ì€ Cloud Functions(functions/index.js)ê°€ ìë™ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // ============================================
        // Firebase ì„¤ì • ë° ì´ˆê¸°í™”
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAW_z3hoI9SZ1-hoxKVYBKs7rbdo8n6wdc",
            authDomain: "plantiaworld.firebaseapp.com",
            projectId: "plantiaworld",
            storageBucket: "plantiaworld.firebasestorage.app",
            messagingSenderId: "18112813073",
            appId: "1:18112813073:web:7247046c038a3831db79b0",
            measurementId: "G-8XSSM279KY"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Firebase Messaging (ì•Œë¦¼ìš©) â€“ ì§€ì› í™˜ê²½ì—ì„œë§Œ ì´ˆê¸°í™”
        let messaging = null;
        try {
            messaging = getMessaging(app);
        } catch (e) {
            console.warn('âš ï¸ Firebase Messaging ì´ˆê¸°í™” ì‹¤íŒ¨ (HTTPS í•„ìš”):', e.message);
        }

        // ì˜¤í”„ë¼ì¸ ì§€ì†ì„± í™œì„±í™” (v10 ë°©ì‹)
        try {
            await enableIndexedDbPersistence(db);
            console.log("ì˜¤í”„ë¼ì¸ ì§€ì› í™œì„±í™”ë¨");
        } catch (err) {
            if (err.code === 'failed-precondition') {
                console.log("ì—¬ëŸ¬ íƒ­ì´ ì—´ë ¤ìˆì–´ ì˜¤í”„ë¼ì¸ ì§€ì› ë¶ˆê°€");
            } else if (err.code === 'unimplemented') {
                console.log("ë¸Œë¼ìš°ì €ê°€ ì˜¤í”„ë¼ì¸ ì§€ì›ì„ í•˜ì§€ ì•ŠìŒ");
            }
        }

        // ============================================
        // ì „ì—­ ë³€ìˆ˜
        // ============================================
        let currentUser = null;
        let otherUser = null;
        let chatData = null;
        let selectedFile = null;
        let unsubscribeMessages = null;

        // URL íŒŒë¼ë¯¸í„° ì¶”ì¶œ (product-detail.htmlì—ì„œ chat-room.html?id=chatId í˜•ì‹ìœ¼ë¡œ ì „ë‹¬)
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('id');

        if (!chatId) {
            alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
            window.location.href = 'index.html';
            throw new Error('ì±„íŒ…ë°© IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        }

        console.log('ğŸ“¨ ì±„íŒ…ë°© ID:', chatId);

        // ============================================
        // 1. ì¸ì¦ ìƒíƒœ ê°ì§€
        // ============================================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log('âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:', user.uid);
                
                try {
                    // âœ… FIX: setupEventListenersë¥¼ ê°€ì¥ ë¨¼ì € ì‹¤í–‰
                    // DOMì€ ì´ë¯¸ ì¤€ë¹„ëìœ¼ë¯€ë¡œ loadChatRoom ì „ì— ë“±ë¡í•´ì•¼ íƒ€ì´ë° ì—ëŸ¬ ì—†ìŒ
                    setupEventListeners();
                    await loadChatRoom();
                    listenToMessages();

                    // â”€â”€â”€ âœ… FCM í† í° ë“±ë¡ & í¬ê·¸ë¼ìš´ë“œ ì•Œë¦¼ â”€â”€â”€â”€â”€â”€
                    setupNotifications(user.uid);
                    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                    console.log('âœ… ì±„íŒ…ë°© ì´ˆê¸°í™” ì™„ë£Œ');
                } catch (error) {
                    console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨ ìƒì„¸:', error.code, error.message, error);
                    if (error.code === 'permission-denied') {
                        alert('ì±„íŒ…ë°© ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                    } else if (error.code === 'not-found') {
                        alert('ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    } else {
                        alert('ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + ')');
                    }
                    window.location.href = 'index.html';
                }
            } else {
                console.log('âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
            }
        });

        // ============================================
        // 0. FCM í† í° ë“±ë¡ & í¬ê·¸ë¼ìš´ë“œ ì•Œë¦¼ ìˆ˜ì‹  ì„¤ì •
        // ============================================
        async function setupNotifications(uid) {
            if (!messaging) return;
            if (!('Notification' in window)) return;

            try {
                // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ì´ë¯¸ grantedë©´ ì¬ìš”ì²­ ì•ˆ í•¨)
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') return;

                if (VAPID_KEY === 'YOUR_VAPID_KEY_HERE') return; // í‚¤ ë¯¸ì„¤ì • ìŠ¤í‚µ

                // FCM í† í° ë°œê¸‰ & ì €ì¥
                const token = await getToken(messaging, { vapidKey: VAPID_KEY });
                if (token) {
                    await updateDoc(doc(db, 'users', uid), {
                        fcmTokens: arrayUnion(token),
                        notificationEnabled: true,
                    }).catch(() => {});
                    console.log('âœ… FCM í† í° ì €ì¥ ì™„ë£Œ');
                }

                // í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹  (ì•±ì´ ì—´ë ¤ ìˆì„ ë•Œ)
                onMessage(messaging, (payload) => {
                    // í˜„ì¬ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ë©´ í† ìŠ¤íŠ¸ ìƒëµ (onSnapshotì´ ì²˜ë¦¬)
                    const payloadChatId = payload.data?.chatId || '';
                    if (payloadChatId === chatId) return;

                    const title = payload.notification?.title || 'ğŸŒ¿ ìƒˆ ë©”ì‹œì§€';
                    const body  = payload.notification?.body  || '';
                    showChatToast(title, body, payloadChatId);
                });

            } catch (err) {
                console.warn('âš ï¸ ì•Œë¦¼ ì„¤ì • ì‹¤íŒ¨ (ë¬´ì‹œ):', err.message);
            }
        }

        // â”€â”€â”€ í¬ê·¸ë¼ìš´ë“œ í† ìŠ¤íŠ¸ ì•Œë¦¼ ë°°ë„ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showChatToast(title, body, targetChatId) {
            document.querySelectorAll('.chat-notif-toast').forEach(n => n.remove());

            const toast = document.createElement('div');
            toast.className = 'chat-notif-toast';
            toast.style.cssText = `
                position:fixed; top:70px; left:50%; transform:translateX(-50%);
                background:#fff; border-radius:14px;
                box-shadow:0 6px 24px rgba(0,0,0,0.14);
                padding:12px 16px; display:flex; align-items:center; gap:10px;
                z-index:99999; max-width:340px; width:calc(100vw - 32px);
                cursor:pointer; border-left:3px solid #10b981;
                animation: chatToastIn 0.25s ease;
            `;
            toast.innerHTML = `
                <style>
                    @keyframes chatToastIn {
                        from { transform:translateX(-50%) translateY(-16px); opacity:0; }
                        to   { transform:translateX(-50%) translateY(0);     opacity:1; }
                    }
                </style>
                <span style="font-size:22px;flex-shrink:0;">ğŸŒ¿</span>
                <div style="flex:1;min-width:0;">
                    <p style="font-size:13px;font-weight:700;color:#111827;margin:0 0 2px;">${escapeHtml(title)}</p>
                    <p style="font-size:12px;color:#6b7280;margin:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(body)}</p>
                </div>
                <button onclick="this.parentElement.remove()"
                        style="background:none;border:none;color:#9ca3af;font-size:18px;cursor:pointer;flex-shrink:0;">Ã—</button>
            `;
            toast.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON' && targetChatId) {
                    window.location.href = `chat-room.html?id=${targetChatId}`;
                }
            });

            document.body.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 5000);
        }

        // ============================================
        // 2. ì±„íŒ…ë°© ì •ë³´ ë¡œë“œ
        // ============================================
        async function loadChatRoom() {
            try {
                const chatDocRef = doc(db, 'chats', chatId);
                const chatSnap = await getDoc(chatDocRef);
                
                if (!chatSnap.exists()) {
                    console.error('âŒ ì±„íŒ…ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    alert('ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }
                
                chatData = chatSnap.data();
                console.log('âœ… ì±„íŒ…ë°© ì •ë³´ ë¡œë“œ:', chatData);
                
                // participants ë°°ì—´ë¡œ ê¶Œí•œ ì²´í¬ (ì—†ìœ¼ë©´ buyerId/sellerIdë¡œ í´ë°±)
                const participants = chatData.participants || 
                    [chatData.buyerId, chatData.sellerId].filter(Boolean);
                
                const isParticipant = participants.includes(currentUser.uid) ||
                    chatData.buyerId === currentUser.uid ||
                    chatData.sellerId === currentUser.uid;
                
                if (!isParticipant) {
                    console.error('âŒ ì±„íŒ… ì°¸ì—¬ìê°€ ì•„ë‹™ë‹ˆë‹¤.');
                    alert('ì±„íŒ… ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }
                
                const otherUserId = participants.find(id => id !== currentUser.uid)
                    || (chatData.buyerId === currentUser.uid ? chatData.sellerId : chatData.buyerId);
                
                if (otherUserId) {
                    await loadOtherUserInfo(otherUserId);
                } else {
                    console.error('âŒ ìƒëŒ€ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ìƒí’ˆ ì •ë³´ ë¡œë“œ
                if (chatData.productId) {
                    await loadProductInfo(chatData.productId);
                }
                
                // ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
                await markAsRead();
                
            } catch (error) {
                console.error('âŒ ì±„íŒ…ë°© ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = 'index.html';
            }
        }

        // ============================================
        // 3. ìƒëŒ€ë°© ì •ë³´ ë¡œë“œ
        // ============================================
        async function loadOtherUserInfo(userId) {
            try {
                const userDocRef = doc(db, 'users', userId);
                const userSnap = await getDoc(userDocRef);
                
                if (userSnap.exists()) {
                    otherUser = { id: userId, ...userSnap.data() };
                    console.log('âœ… ìƒëŒ€ë°© ì •ë³´ ë¡œë“œ:', otherUser);
                    
                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('otherUserName').textContent = otherUser.displayName || otherUser.username || otherUser.nickname || otherUser.email || 'ì‚¬ìš©ì';
                    document.getElementById('otherUserImg').src = otherUser.profileImage || otherUser.photoURL || 'data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%20viewBox%3D%220%200%2040%2040%22%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2220%22%20r%3D%2220%22%20fill%3D%22%2310b981%22%2F%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2215%22%20r%3D%228%22%20fill%3D%22white%22%2F%3E%3Cellipse%20cx%3D%2220%22%20cy%3D%2235%22%20rx%3D%2212%22%20ry%3D%228%22%20fill%3D%22white%22%2F%3E%3C%2Fsvg%3E';
                    
                    // ì´ë¯¸ì§€ ì—ëŸ¬ ì²˜ë¦¬
                    document.getElementById('otherUserImg').onerror = function() {
                        this.src = 'data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%20viewBox%3D%220%200%2040%2040%22%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2220%22%20r%3D%2220%22%20fill%3D%22%2310b981%22%2F%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2215%22%20r%3D%228%22%20fill%3D%22white%22%2F%3E%3Cellipse%20cx%3D%2220%22%20cy%3D%2235%22%20rx%3D%2212%22%20ry%3D%228%22%20fill%3D%22white%22%2F%3E%3C%2Fsvg%3E';
                    };
                    
                    // ì˜¨ë¼ì¸ ìƒíƒœ í‘œì‹œ
                    updateOnlineStatus(otherUser);
                } else {
                    console.log('âš ï¸ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    document.getElementById('otherUserName').textContent = 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì';
                }
            } catch (error) {
                console.error('âŒ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('otherUserName').textContent = 'ì‚¬ìš©ì';
            }
        }

        // ============================================
        // 3-1. ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
        // ============================================
        async function markAsRead() {
            if (!currentUser || !chatId) return;
            
            try {
                const chatDocRef = doc(db, 'chats', chatId);
                
                // í˜„ì¬ ì‚¬ìš©ìì˜ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                await updateDoc(chatDocRef, {
                    [`unreadCount.${currentUser.uid}`]: 0
                });
                
                console.log('âœ… ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            } catch (error) {
                console.error('âš ï¸ ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ê°€ ë‚˜ë„ ì±„íŒ…ì€ ê³„ì† ì§„í–‰
            }
        }

        // ============================================
        // 4. ìƒí’ˆ ì •ë³´ ë¡œë“œ
        // ============================================
        async function loadProductInfo(productId) {
            if (!productId) {
                console.log('âš ï¸ ìƒí’ˆ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const productDocRef = doc(db, 'products', productId);
                const productSnap = await getDoc(productDocRef);
                
                if (productSnap.exists()) {
                    const product = productSnap.data();
                    console.log('âœ… ìƒí’ˆ ì •ë³´ ë¡œë“œ:', product);
                    
                    const price = product.price === 0 ? 'ë‚˜ëˆ” ğŸŒ±' : `${(product.price || 0).toLocaleString()}ì›`;
                    
                    document.getElementById('productTitle').textContent = product.title || 'ìƒí’ˆ';
                    document.getElementById('productPrice').textContent = price;
                    document.getElementById('productImg').src = product.images?.[0] || 'data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%23e8f5e9%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-size%3D%2260%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3E%F0%9F%8C%BF%3C%2Ftext%3E%3C%2Fsvg%3E';

                    // âœ… FIX: dealBtnì€ ì ˆëŒ€ DOMì—ì„œ ì œê±°í•˜ì§€ ì•ŠìŒ
                    // replaceChildë¡œ ì œê±°í•˜ë©´ ì´í›„ getElementById('dealBtn')ì´ nullì„ ë°˜í™˜í•˜ì—¬ ì—ëŸ¬ ë°œìƒ
                    const dealBtn = document.getElementById('dealBtn');
                    const isSeller = currentUser && chatData && currentUser.uid === chatData.sellerId;

                    // ê¸°ì¡´ ìƒíƒœ ë±ƒì§€ ì¤‘ë³µ ë°©ì§€
                    const existingBadge = document.getElementById('dealStatusBadge');
                    if (existingBadge) existingBadge.remove();

                    if (isSeller) {
                        // íŒë§¤ì: ë²„íŠ¼ í‘œì‹œ ë° ìƒíƒœ ë°˜ì˜
                        if (dealBtn) {
                            dealBtn.style.display = '';
                            updateDealBtnLabel(product.status || 'íŒë§¤ì¤‘');
                        }
                    } else {
                        // êµ¬ë§¤ì: ë²„íŠ¼ì€ DOMì— ìœ ì§€í•˜ê³  ìˆ¨ê¹€, ë±ƒì§€ë¥¼ ì˜†ì— ì¶”ê°€
                        if (dealBtn) {
                            dealBtn.style.display = 'none';
                            const statusBadge = document.createElement('span');
                            statusBadge.id = 'dealStatusBadge';
                            statusBadge.className = 'text-xs font-bold px-2 py-1 rounded-lg';
                            const s = product.status || 'íŒë§¤ì¤‘';
                            statusBadge.style.cssText = s === 'íŒë§¤ì™„ë£Œ'
                                ? 'background:#fef2f2;color:#dc2626'
                                : s === 'ì˜ˆì•½ì¤‘'
                                ? 'background:#fff7ed;color:#ea580c'
                                : 'background:#ecfdf5;color:#065f46';
                            statusBadge.textContent = s;
                            // âœ… replaceChild ëŒ€ì‹  insertBeforeë¡œ ì˜†ì— ì‚½ì… (dealBtnì€ DOM ìœ ì§€)
                            dealBtn.parentNode.insertBefore(statusBadge, dealBtn);
                        }
                    }

                    // ìƒí’ˆ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                    const productImg = document.getElementById('productImg');
                    if (productImg) {
                        productImg.style.cursor = 'pointer';
                        productImg.onclick = () => {
                            window.location.href = `product-detail.html?id=${productId}`;
                        };
                    }
                } else {
                    console.log('âš ï¸ ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ ìƒí’ˆ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ============================================
        // 5. ë©”ì‹œì§€ ì‹¤ì‹œê°„ ìˆ˜ì‹ 
        // ============================================
        function listenToMessages() {
            const messagesRef = collection(db, 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'));

            // âœ… BUG FIX #2: isInitialLoad + docChanges() ì¡°í•© ì œê±°
            //    â†’ í•­ìƒ ì „ì²´ ì¬ë Œë”ë§ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
            //    ì´ìœ : serverTimestamp() íœë”© ìƒíƒœì—ì„œ added/modified ì´ì¤‘ ë°œí™” íƒ€ì´ë° ë²„ê·¸
            //          ì‹¤ì œ ì±„íŒ… ë©”ì‹œì§€ëŠ” ë§ì§€ ì•Šìœ¼ë¯€ë¡œ ì „ì²´ ì¬ë Œë”ë§ì´ ë” ì•ˆì •ì 
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const chatContainer = document.getElementById('chatMessages');

                // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ê¸°ì–µ (ë§¨ ì•„ë˜ ìˆì—ˆìœ¼ë©´ ì¬ë Œë” í›„ì—ë„ ë§¨ ì•„ë˜ ìœ ì§€)
                const wasAtBottom = chatContainer.scrollHeight - chatContainer.scrollTop 
                                    <= chatContainer.clientHeight + 80;

                // ì „ì²´ ì¬ë Œë”ë§
                chatContainer.innerHTML = '';
                snapshot.docs.forEach((doc) => {
                    const messageData = doc.data();
                    const messageElement = createMessageElement(doc.id, messageData);
                    chatContainer.appendChild(messageElement);
                });

                if (wasAtBottom) scrollToBottom();

                console.log(`âœ… ë©”ì‹œì§€ ${snapshot.docs.length}ê°œ ë Œë”ë§`);

            }, (error) => {
                console.error('âŒ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹¤íŒ¨:', error);
                if (error.code === 'permission-denied') {
                    alert('ë©”ì‹œì§€ë¥¼ ë³¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                }
            });
        }

        // ============================================
        // 6. ë©”ì‹œì§€ UI ìƒì„±
        // ============================================
        function createMessageElement(messageId, data) {
            const isMyMessage = data.senderId === currentUser.uid;
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isMyMessage ? 'justify-end' : 'justify-start'}`;
            messageDiv.setAttribute('data-message-id', messageId);
            
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì²˜ë¦¬
            if (data.type === 'system') {
                messageDiv.innerHTML = `
                    <div class="w-full text-center">
                        <span class="inline-block bg-gray-200 text-gray-600 text-xs px-3 py-1 rounded-full">
                            ${escapeHtml(data.text || '')}
                        </span>
                    </div>
                `;
                return messageDiv;
            }
            
            let messageContent = '';
            
            // í…ìŠ¤íŠ¸ ë©”ì‹œì§€
            if (data.text) {
                // ë§í¬ ìë™ ê°ì§€ ë° ë³€í™˜ (ì„ íƒ ì‚¬í•­)
                const textWithLinks = escapeHtml(data.text).replace(
                    /(https?:\/\/[^\s]+)/g, 
                    '<a href="$1" target="_blank" class="underline">$1</a>'
                );
                messageContent = `<p class="break-words whitespace-pre-wrap">${textWithLinks}</p>`;
            }
            
            // ì´ë¯¸ì§€ ë©”ì‹œì§€
            if (data.imageUrl) {
                messageContent += `
                    <img src="${escapeHtml(data.imageUrl)}" 
                         class="image-message" 
                         onclick="showImageModal('${escapeHtml(data.imageUrl)}')"
                         onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%23f3f4f6%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-size%3D%2240%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3E%E2%9D%8C%3C%2Ftext%3E%3C%2Fsvg%3E'"
                         loading="lazy">
                `;
            }
            
            // ì¼ë°˜ ë©”ì‹œì§€
            const senderName = isMyMessage ? 'ë‚˜' : (otherUser?.displayName || otherUser?.username || otherUser?.nickname || otherUser?.email || 'ì‚¬ìš©ì');
            const isDeleted = data.deleted === true;

            messageDiv.innerHTML = `
                <div class="flex items-end gap-1 ${isMyMessage ? 'flex-row-reverse' : 'flex-row'} max-w-[75%]">
                    <div class="flex flex-col ${isMyMessage ? 'items-end' : 'items-start'}">
                        ${!isMyMessage ? `<span class="text-xs text-gray-500 mb-1 ml-1">${escapeHtml(senderName)}</span>` : ''}
                        <div class="message-bubble ${isMyMessage ? 'my-message' : 'other-message'} ${isDeleted ? 'opacity-50' : ''}">
                            ${isDeleted
                                ? '<p class="text-xs italic" style="opacity:0.7"><i class="fas fa-ban" style="margin-right:4px"></i>ì‚­ì œëœ ë©”ì‹œì§€ì…ë‹ˆë‹¤</p>'
                                : messageContent}
                        </div>
                        <span class="text-[10px] text-gray-400 mt-1 mx-1">
                            ${formatTimestamp(data.timestamp)}
                        </span>
                    </div>
                    ${isMyMessage && !isDeleted ? `
                        <button onclick="confirmDeleteMessage('${messageId}')"
                                class="delete-msg-btn"
                                title="ë©”ì‹œì§€ ì‚­ì œ">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    ` : ''}
                </div>
            `;
            
            return messageDiv;
        }

        // ============================================
        // 7. ë©”ì‹œì§€ ì „ì†¡
        // ============================================
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            if (!text && !selectedFile) {
                console.log('âš ï¸ ì „ì†¡í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // ì „ì†¡ ì¤‘ ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ ì „ì†¡ ë°©ì§€)
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) { sendBtn.disabled = true; sendBtn.style.opacity = '0.5'; }
            
            try {
                const messageData = {
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email || 'ìµëª…',
                    timestamp: serverTimestamp(),
                    type: 'text'
                };
                
                if (text) messageData.text = text;
                
                if (selectedFile) {
                    console.log('ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...');
                    const imageUrl = await uploadImage(selectedFile);
                    messageData.imageUrl = imageUrl;
                    messageData.type = text ? 'text' : 'image';
                    console.log('âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ:', imageUrl);
                }
                
                // Firestoreì— ë©”ì‹œì§€ ì¶”ê°€
                const messagesRef = collection(db, 'chats', chatId, 'messages');
                await addDoc(messagesRef, messageData);
                console.log('âœ… ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ');
                
                // ì±„íŒ…ë°© lastMessage & ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
                const chatDocRef = doc(db, 'chats', chatId);
                const updateData = {
                    lastMessage: text || 'ì‚¬ì§„ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.',
                    lastMessageTime: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                if (otherUser && otherUser.id) {
                    updateData[`unreadCount.${otherUser.id}`] = increment(1);
                }
                
                await updateDoc(chatDocRef, updateData);

                // â”€â”€â”€ âœ… í‘¸ì‹œ ì•Œë¦¼ì€ Cloud Functionsê°€ ìë™ ì²˜ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                //    addDoc(messages) ì™„ë£Œ â†’ Firestore íŠ¸ë¦¬ê±° ë°œë™
                //    â†’ functions/index.js â†’ FCM V1 API â†’ ìƒëŒ€ë°© ê¸°ê¸°
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                messageInput.value = '';
                messageInput.style.height = 'auto';
                clearFilePreview();
                if (sendBtn) { sendBtn.disabled = false; sendBtn.style.opacity = '1'; }
                
            } catch (error) {
                console.error('âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                if (sendBtn) { sendBtn.disabled = false; sendBtn.style.opacity = '1'; }
                
                if (error.code === 'permission-denied') {
                    alert('ë©”ì‹œì§€ ì „ì†¡ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            }
        }

        // ============================================
        // 8. ì´ë¯¸ì§€ ì—…ë¡œë“œ
        // ============================================
        async function uploadImage(file) {
            return new Promise((resolve, reject) => {
                try {
                    const fileName = `chat_images/${chatId}/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, fileName);
                    const uploadTask = uploadBytesResumable(storageRef, file);
                    
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log(`ğŸ“¤ ì—…ë¡œë“œ ì§„í–‰: ${progress.toFixed(0)}%`);
                            
                            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸ (ì„ íƒ ì‚¬í•­)
                            const preview = document.getElementById('filePreview');
                            if (preview && !preview.classList.contains('hidden')) {
                                preview.querySelector('.text-xs')?.insertAdjacentHTML('beforeend', 
                                    ` - ${progress.toFixed(0)}%`);
                            }
                        },
                        (error) => {
                            console.error('âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                            
                            if (error.code === 'storage/unauthorized') {
                                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                            } else if (error.code === 'storage/quota-exceeded') {
                                alert('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                            } else {
                                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            }
                            
                            reject(error);
                        },
                        async () => {
                            try {
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                console.log('âœ… ì´ë¯¸ì§€ URL:', downloadURL);
                                resolve(downloadURL);
                            } catch (error) {
                                console.error('âŒ URL ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                                reject(error);
                            }
                        }
                    );
                } catch (error) {
                    console.error('âŒ ì—…ë¡œë“œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    reject(error);
                }
            });
        }

        // ============================================
        // 9. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        // ============================================
        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const fileInput = document.getElementById('fileInput');
            const attachBtn = document.getElementById('attachBtn');
            const menuBtn = document.getElementById('menuBtn');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const dealBtn = document.getElementById('dealBtn');

            // âœ… FIX: null ì²´í¬ - í•„ìˆ˜ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ëŒ€ì‹  ê²½ê³  í›„ ì¢…ë£Œ
            if (!sendBtn || !messageInput || !fileInput || !attachBtn || !menuBtn || !dropdownMenu) {
                console.error('âŒ setupEventListeners: í•„ìˆ˜ DOM ìš”ì†Œ ëˆ„ë½', {
                    sendBtn: !!sendBtn,
                    messageInput: !!messageInput,
                    fileInput: !!fileInput,
                    attachBtn: !!attachBtn,
                    menuBtn: !!menuBtn,
                    dropdownMenu: !!dropdownMenu
                });
                return;
            }

            // ë©”ì‹œì§€ ì „ì†¡
            sendBtn.onclick = sendMessage;
            
            // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
            messageInput.onkeypress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };
            
            // í…ìŠ¤íŠ¸ ì…ë ¥ì°½ ìë™ ë†’ì´ ì¡°ì •
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // íŒŒì¼ ì²¨ë¶€ ë²„íŠ¼
            attachBtn.onclick = () => fileInput.click();
            
            // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
            fileInput.onchange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    selectedFile = e.target.files[0];
                    showFilePreview(selectedFile);
                }
            };
            
            // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í† ê¸€
            menuBtn.onclick = (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('show');
            };
            
            // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener('click', () => {
                dropdownMenu.classList.remove('show');
            });
            
            // âœ… FIX: dealBtn null ì²´í¬ (loadProductInfoì—ì„œ ìˆ¨ê²¨ì ¸ë„ DOMì€ ìœ ì§€ë¨)
            if (dealBtn) {
                dealBtn.onclick = () => openDealModal();
            }
        }

        // ============================================
        // 10. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        // ============================================
        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            setTimeout(() => {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function showFilePreview(file) {
            const preview = document.getElementById('filePreview');
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = `
                        <div class="flex items-center bg-white p-3 rounded-lg border">
                            <img src="${e.target.result}" class="w-16 h-16 object-cover rounded">
                            <div class="ml-3 flex-1">
                                <p class="text-sm font-medium text-gray-700 truncate">${file.name}</p>
                                <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(2)} KB</p>
                            </div>
                            <button onclick="clearFilePreview()" class="text-gray-400 hover:text-red-500 ml-2">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // 1ë¶„ ë¯¸ë§Œ
            if (diff < 60000) return 'ë°©ê¸ˆ';
            
            // 1ì‹œê°„ ë¯¸ë§Œ
            if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return `${minutes}ë¶„ ì „`;
            }
            
            // ì˜¤ëŠ˜
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            }
            
            // ì–´ì œ
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return 'ì–´ì œ ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            }
            
            // ê·¸ ì™¸
            return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        }

        function updateOnlineStatus(user) {
            // ì‹¤ì œ ì˜¨ë¼ì¸ ìƒíƒœ êµ¬í˜„ ê°€ëŠ¥
            // ì˜ˆ: Realtime Databaseì˜ presence ì‹œìŠ¤í…œ í™œìš©
            document.getElementById('statusText').textContent = 'ì‘ë‹µ ë¹ ë¦„';
        }

        function escapeHtml(text) {
            // âœ… FIX: null/undefined ë°©ì–´ ì²˜ë¦¬ (ì†Œí”„íŠ¸ ì‚­ì œ ë©”ì‹œì§€ì—ì„œ textê°€ nullì¼ ìˆ˜ ìˆìŒ)
            if (text === null || text === undefined) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // ============================================
        // 11. ì „ì—­ í•¨ìˆ˜ (window ê°ì²´ì— í• ë‹¹)
        // ============================================
        window.clearFilePreview = function() {
            const preview = document.getElementById('filePreview');
            // âœ… FIX: null ì²´í¬ ì¶”ê°€
            if (preview) {
                preview.innerHTML = '';
                preview.classList.add('hidden');
            }
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
            selectedFile = null;
        };

        window.showImageModal = function(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModal').classList.remove('hidden');
            document.getElementById('imageModal').classList.add('flex');
        };

        window.closeImageModal = function() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageModal').classList.remove('flex');
            document.getElementById('modalImage').src = '';
        };

        // âœ… ì‚­ì œ í™•ì¸ í† ìŠ¤íŠ¸ UI (confirm ëŒ€ì‹  ì¸ë¼ì¸ í™•ì¸)
        window.confirmDeleteMessage = function(messageId) {
            // ê¸°ì¡´ í™•ì¸ íŒì—… ì œê±°
            const existing = document.getElementById('deleteConfirmPopup');
            if (existing) existing.remove();

            const popup = document.createElement('div');
            popup.id = 'deleteConfirmPopup';
            popup.style.cssText = `
                position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
                background: #1f2937; color: white; border-radius: 14px;
                padding: 14px 20px; z-index: 9999; display: flex;
                align-items: center; gap: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                font-size: 14px; font-family: 'Noto Sans KR', sans-serif;
            `;
            popup.innerHTML = `
                <span>ë©”ì‹œì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?</span>
                <button onclick="deleteMessage('${messageId}'); document.getElementById('deleteConfirmPopup').remove();"
                        style="background:#ef4444; border:none; color:white; padding:6px 14px; border-radius:8px; cursor:pointer; font-size:13px; font-weight:600;">
                    ì‚­ì œ
                </button>
                <button onclick="document.getElementById('deleteConfirmPopup').remove();"
                        style="background:#374151; border:none; color:#d1d5db; padding:6px 14px; border-radius:8px; cursor:pointer; font-size:13px;">
                    ì·¨ì†Œ
                </button>
            `;
            document.body.appendChild(popup);

            // 3ì´ˆ í›„ ìë™ ë‹«í˜
            setTimeout(() => { if (popup.parentNode) popup.remove(); }, 3000);
        };

        window.deleteMessage = async function(messageId) {
            try {
                const messageDocRef = doc(db, 'chats', chatId, 'messages', messageId);
                // âœ… ì‹¤ì œ ì‚­ì œ ëŒ€ì‹  deleted í”Œë˜ê·¸ë¡œ ì†Œí”„íŠ¸ ì‚­ì œ
                //    â†’ ìƒëŒ€ë°© í™”ë©´ì—ë„ "ì‚­ì œëœ ë©”ì‹œì§€" í‘œì‹œ
                await updateDoc(messageDocRef, {
                    deleted: true,
                    deletedAt: serverTimestamp(),
                    text: null,
                    imageUrl: null
                });
                console.log('âœ… ë©”ì‹œì§€ ì‚­ì œ ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨:', error);
                if (error.code === 'permission-denied') {
                    alert('ë©”ì‹œì§€ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. Firebase Rulesë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                } else {
                    alert('ë©”ì‹œì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        };

        // ============================================
        // ê±°ë˜ ì˜ˆì•½ ê¸°ëŠ¥
        // ============================================
        let selectedDealStatus = null;

        function updateDealBtnLabel(status) {
            const btn = document.getElementById('dealBtn');
            if (!btn) return;
            btn.classList.remove('status-reserved', 'status-sold');
            if (status === 'ì˜ˆì•½ì¤‘') {
                btn.textContent = 'ğŸŸ  ì˜ˆì•½ì¤‘';
                btn.classList.add('status-reserved');
            } else if (status === 'íŒë§¤ì™„ë£Œ') {
                btn.textContent = 'ğŸ”´ íŒë§¤ì™„ë£Œ';
                btn.classList.add('status-sold');
            } else {
                btn.textContent = 'ê±°ë˜ ì˜ˆì•½';
            }
        }

        window.openDealModal = function() {
            if (!chatData || !chatData.productId) {
                alert('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            // âœ… FIX: currentUser null ì²´í¬ ì¶”ê°€
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            // íŒë§¤ìë§Œ ì‚¬ìš© ê°€ëŠ¥
            if (currentUser.uid !== chatData.sellerId) {
                alert('ê±°ë˜ ìƒíƒœëŠ” íŒë§¤ìë§Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            selectedDealStatus = null;

            // ìƒí’ˆëª… í‘œì‹œ
            const titleEl = document.getElementById('productTitle');
            document.getElementById('dealProductName').textContent =
                titleEl?.textContent || 'ìƒí’ˆ';

            // ì„ íƒ ì´ˆê¸°í™”
            ['btnSelling','btnReserved','btnSold'].forEach(id => {
                const btn = document.getElementById(id);
                btn.classList.remove('selected','selected-orange','selected-red');
            });
            const confirmBtn = document.getElementById('dealConfirmBtn');
            confirmBtn.className = 'deal-confirm-btn inactive';
            confirmBtn.textContent = 'ë³€ê²½í•˜ê¸°';
            confirmBtn.disabled = false;  // âœ… BUG FIX: ì´ì „ ì‹¤í–‰ì˜ disabled ìƒíƒœ ë°˜ë“œì‹œ ì´ˆê¸°í™”

            document.getElementById('dealModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        };

        window.closeDealModal = function(e) {
            if (!e || e.target === document.getElementById('dealModal')) {
                document.getElementById('dealModal').style.display = 'none';
                document.body.style.overflow = '';
                selectedDealStatus = null;
            }
        };

        window.selectDealStatus = function(status) {
            selectedDealStatus = status;
            // ìŠ¤íƒ€ì¼ ë¦¬ì…‹
            document.getElementById('btnSelling').classList.remove('selected','selected-orange','selected-red');
            document.getElementById('btnReserved').classList.remove('selected','selected-orange','selected-red');
            document.getElementById('btnSold').classList.remove('selected','selected-orange','selected-red');

            if (status === 'íŒë§¤ì¤‘')   document.getElementById('btnSelling').classList.add('selected');
            if (status === 'ì˜ˆì•½ì¤‘')   document.getElementById('btnReserved').classList.add('selected-orange');
            if (status === 'íŒë§¤ì™„ë£Œ') document.getElementById('btnSold').classList.add('selected-red');

            const confirmBtn = document.getElementById('dealConfirmBtn');
            confirmBtn.className = 'deal-confirm-btn active';
            confirmBtn.textContent = `"${status}"(ìœ¼)ë¡œ ë³€ê²½í•˜ê¸°`;
        };

        window.confirmDealStatus = async function() {
            if (!selectedDealStatus) return;
            const confirmBtn = document.getElementById('dealConfirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'ë³€ê²½ ì¤‘...';

            try {
                // products/{id} ìƒíƒœ ë³€ê²½
                await updateDoc(doc(db, 'products', chatData.productId), {
                    status: selectedDealStatus
                });

                // ì±„íŒ…ë°©ì— ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡
                const statusEmoji = selectedDealStatus === 'íŒë§¤ì™„ë£Œ' ? 'ğŸ”´' : selectedDealStatus === 'ì˜ˆì•½ì¤‘' ? 'ğŸŸ ' : 'ğŸŸ¢';
                await addDoc(collection(db, 'chats', chatId, 'messages'), {
                    type: 'system',
                    text: `${statusEmoji} ê±°ë˜ ìƒíƒœê°€ "${selectedDealStatus}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`,
                    senderId: currentUser.uid,
                    timestamp: serverTimestamp()
                });

                // ë²„íŠ¼ ë¼ë²¨ ì—…ë°ì´íŠ¸
                updateDealBtnLabel(selectedDealStatus);

                // âœ… BUG FIX: ì„±ê³µ í›„ ë²„íŠ¼ ìƒíƒœ ì™„ì „ ì´ˆê¸°í™” í›„ ëª¨ë‹¬ ë‹«ê¸°
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'ë³€ê²½í•˜ê¸°';
                confirmBtn.className = 'deal-confirm-btn inactive';
                selectedDealStatus = null;

                document.getElementById('dealModal').style.display = 'none';
                document.body.style.overflow = '';

                // í† ìŠ¤íŠ¸
                showDealToast(`ê±°ë˜ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`);

            } catch (error) {
                console.error('ê±°ë˜ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
                confirmBtn.disabled = false;
                confirmBtn.textContent = `"${selectedDealStatus}"(ìœ¼)ë¡œ ë³€ê²½í•˜ê¸°`;
                if (error.code === 'permission-denied') {
                    alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. íŒë§¤ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                } else {
                    alert('ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            }
        };

        function showDealToast(msg) {
            const t = document.createElement('div');
            t.style.cssText = `
                position:fixed; bottom:90px; left:50%; transform:translateX(-50%);
                background:#059669; color:white; padding:12px 22px;
                border-radius:12px; font-size:14px; font-weight:600;
                z-index:9999; box-shadow:0 4px 14px rgba(5,150,105,0.4);
                font-family:'Noto Sans KR',sans-serif;
            `;
            t.innerHTML = `<i class="fas fa-check-circle" style="margin-right:8px"></i>${msg}`;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }

        window.muteChat = function() {
            alert('ì•Œë¦¼ì´ êº¼ì¡ŒìŠµë‹ˆë‹¤.');
            document.getElementById('dropdownMenu').classList.remove('show');
        };

        window.searchChat = function() {
            alert('ëŒ€í™” ê²€ìƒ‰ ê¸°ëŠ¥ì´ ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.');
            document.getElementById('dropdownMenu').classList.remove('show');
        };

        window.leaveChat = async function() {
            if (confirm('ì •ë§ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ë‚˜ê°€ë©´ ëŒ€í™” ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
                try {
                    // leftBy ë°°ì—´ì— ë‚´ uid ì¶”ê°€ (ì†Œí”„íŠ¸ ì‚­ì œ)
                    await updateDoc(doc(db, 'chats', chatId), {
                        leftBy: arrayUnion(currentUser.uid)
                    });
                    console.log('âœ… ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì™„ë£Œ');
                } catch (e) {
                    console.warn('âš ï¸ ë‚˜ê°€ê¸° ì²˜ë¦¬ ì‹¤íŒ¨ (ë¬´ì‹œ):', e);
                }
                history.back();
            }
            document.getElementById('dropdownMenu').classList.remove('show');
        };

        window.reportChat = function() {
            alert('ì‹ ê³  ê¸°ëŠ¥ì´ ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.');
            document.getElementById('dropdownMenu').classList.remove('show');
        };

        // ============================================
        // 12. í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        // ============================================
        window.addEventListener('beforeunload', () => {
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
        });
    </script>

    <!-- âœ… PWA Service Worker ë“±ë¡ -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('âœ… SW ë“±ë¡ ì™„ë£Œ:', reg.scope))
                    .catch(err => console.warn('âŒ SW ë“±ë¡ ì‹¤íŒ¨:', err));
            });
        }
    </script>
</body>
</html>
