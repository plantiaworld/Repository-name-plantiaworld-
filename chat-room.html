<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ…ë°© - PlantiaWorld</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f1f5f9; height: 100vh; display: flex; flex-direction: column; }
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        .message-bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 15px; line-height: 1.5; position: relative; }
        .my-message { background-color: #16a34a; color: white; border-bottom-right-radius: 4px; align-self: flex-end; }
        .other-message { background-color: white; color: #334155; border-bottom-left-radius: 4px; align-self: flex-start; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chat-input-area { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .image-message { max-width: 200px; border-radius: 12px; margin-top: 4px; cursor: pointer; }
        .message-menu { position: absolute; top: 8px; right: 8px; opacity: 0; transition: opacity 0.2s; }
        .message-bubble:hover .message-menu { opacity: 1; }
        textarea { max-height: 120px; overflow-y: auto; }
        
        /* ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 140px;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #334155;
            transition: background 0.2s;
        }
        .dropdown-item:hover { background: #f1f5f9; }
        .dropdown-item.danger { color: #dc2626; }
    </style>
</head>
<body class="bg-gray-50">

    <header class="bg-white border-b border-gray-100 px-4 py-3 flex items-center sticky top-0 z-10">
        <button onclick="history.back()" class="mr-3 text-gray-500"><i class="fas fa-chevron-left text-xl"></i></button>
        <div class="flex items-center flex-1">
            <img id="otherUserImg" src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%20viewBox%3D%220%200%2040%2040%22%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2220%22%20r%3D%2220%22%20fill%3D%22%2310b981%22%2F%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2215%22%20r%3D%228%22%20fill%3D%22white%22%2F%3E%3Cellipse%20cx%3D%2220%22%20cy%3D%2235%22%20rx%3D%2212%22%20ry%3D%228%22%20fill%3D%22white%22%2F%3E%3C%2Fsvg%3E" class="w-10 h-10 rounded-full border border-gray-100">
            <div class="ml-3">
                <h3 id="otherUserName" class="font-bold text-gray-800">ë¡œë”© ì¤‘...</h3>
                <p class="text-[10px] text-green-500 flex items-center"><span id="onlineStatus" class="w-2 h-2 bg-green-500 rounded-full mr-1"></span> <span id="statusText">ì‘ë‹µ ë¹ ë¦„</span></p>
            </div>
        </div>
        <div class="relative">
            <button id="menuBtn" class="text-gray-400 hover:text-gray-600"><i class="fas fa-ellipsis-v"></i></button>
            <div id="dropdownMenu" class="dropdown-menu">
                <div class="dropdown-item" onclick="muteChat()"><i class="fas fa-volume-mute mr-2"></i>ì•Œë¦¼ ë„ê¸°</div>
                <div class="dropdown-item" onclick="searchChat()"><i class="fas fa-search mr-2"></i>ëŒ€í™” ê²€ìƒ‰</div>
                <div class="dropdown-item danger" onclick="leaveChat()"><i class="fas fa-sign-out-alt mr-2"></i>ì±„íŒ…ë°© ë‚˜ê°€ê¸°</div>
                <div class="dropdown-item danger" onclick="reportChat()"><i class="fas fa-flag mr-2"></i>ì‹ ê³ í•˜ê¸°</div>
            </div>
        </div>
    </header>

    <div class="bg-white px-4 py-2 border-b border-gray-100 flex items-center justify-between">
        <div class="flex items-center">
            <img id="productImg" src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%23e8f5e9%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-size%3D%2260%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3E%F0%9F%8C%BF%3C%2Ftext%3E%3C%2Fsvg%3E" class="w-12 h-12 rounded-lg object-cover">
            <div class="ml-3">
                <p id="productTitle" class="text-sm font-semibold text-gray-700">ë¡œë”© ì¤‘...</p>
                <p id="productPrice" class="text-xs font-bold text-gray-900">0ì›</p>
            </div>
        </div>
        <button id="dealBtn" class="bg-green-50 text-green-600 px-3 py-1.5 rounded-lg text-xs font-bold border border-green-100 hover:bg-green-100 transition">ê±°ë˜ ì˜ˆì•½</button>
    </div>

    <div id="chatMessages" class="chat-container flex flex-col space-y-4 pb-24">
        <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>

    <div class="chat-input-area fixed bottom-0 left-0 right-0 p-4 border-t border-gray-100">
        <div class="max-w-4xl mx-auto flex items-end space-x-3">
            <div class="relative">
                <button id="attachBtn" class="mb-2 text-gray-400 hover:text-green-600 transition">
                    <i class="fas fa-plus-circle text-2xl"></i>
                </button>
                <input type="file" id="fileInput" accept="image/*" class="hidden">
            </div>
            <div class="flex-1 bg-gray-100 rounded-[1.5rem] px-4 py-2 flex items-center">
                <textarea id="messageInput" rows="1" class="w-full bg-transparent border-none focus:ring-0 text-sm resize-none py-1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
            <button id="sendBtn" class="mb-1 bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg shadow-green-200 active:scale-90 transition hover:bg-green-700">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div id="filePreview" class="max-w-4xl mx-auto mt-2 hidden">
            <!-- íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden items-center justify-center p-4">
        <div class="relative max-w-4xl max-h-full">
            <img id="modalImage" src="" class="max-w-full max-h-[80vh] rounded-lg">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-2xl bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Firebase v10 ëª¨ë“ˆ ë°©ì‹ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        // ============================================
        // Firebase v10 SDK Import
        // ============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            serverTimestamp,
            doc,
            getDoc,
            deleteDoc,
            updateDoc,
            increment,
            enableIndexedDbPersistence 
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { 
            getStorage, 
            ref, 
            uploadBytesResumable, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

        // ============================================
        // Firebase ì„¤ì • ë° ì´ˆê¸°í™”
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAW_z3hoI9SZ1-hoxKVYBKs7rbdo8n6wdc",
            authDomain: "plantiaworld.firebaseapp.com",
            projectId: "plantiaworld",
            storageBucket: "plantiaworld.firebasestorage.app",
            messagingSenderId: "18112813073",
            appId: "1:18112813073:web:7247046c038a3831db79b0",
            measurementId: "G-8XSSM279KY"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // ì˜¤í”„ë¼ì¸ ì§€ì†ì„± í™œì„±í™” (v10 ë°©ì‹)
        try {
            await enableIndexedDbPersistence(db);
            console.log("ì˜¤í”„ë¼ì¸ ì§€ì› í™œì„±í™”ë¨");
        } catch (err) {
            if (err.code === 'failed-precondition') {
                console.log("ì—¬ëŸ¬ íƒ­ì´ ì—´ë ¤ìˆì–´ ì˜¤í”„ë¼ì¸ ì§€ì› ë¶ˆê°€");
            } else if (err.code === 'unimplemented') {
                console.log("ë¸Œë¼ìš°ì €ê°€ ì˜¤í”„ë¼ì¸ ì§€ì›ì„ í•˜ì§€ ì•ŠìŒ");
            }
        }

        // ============================================
        // ì „ì—­ ë³€ìˆ˜
        // ============================================
        let currentUser = null;
        let otherUser = null;
        let chatData = null;
        let selectedFile = null;
        let unsubscribeMessages = null;

        // URL íŒŒë¼ë¯¸í„° ì¶”ì¶œ (product-detail.htmlì—ì„œ chat-room.html?id=chatId í˜•ì‹ìœ¼ë¡œ ì „ë‹¬)
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('id');

        if (!chatId) {
            alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
            window.location.href = 'index.html';
            throw new Error('ì±„íŒ…ë°© IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        }

        console.log('ğŸ“¨ ì±„íŒ…ë°© ID:', chatId);

        // ============================================
        // 1. ì¸ì¦ ìƒíƒœ ê°ì§€
        // ============================================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log('âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:', user.uid);
                console.log('ğŸ“§ ì´ë©”ì¼:', user.email);
                console.log('ğŸ‘¤ ë‹‰ë„¤ì„:', user.displayName);
                
                try {
                    // ì±„íŒ…ë°© ì •ë³´ ë¡œë“œ (ìƒí’ˆ ì •ë³´ë„ í•¨ê»˜ ë¡œë“œë¨)
                    await loadChatRoom();
                    
                    // ë©”ì‹œì§€ ì‹¤ì‹œê°„ ìˆ˜ì‹  ì‹œì‘
                    listenToMessages();
                    
                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                    setupEventListeners();
                    
                    console.log('âœ… ì±„íŒ…ë°© ì´ˆê¸°í™” ì™„ë£Œ');
                } catch (error) {
                    console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    alert('ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                }
            } else {
                console.log('âŒ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
            }
        });

        // ============================================
        // 2. ì±„íŒ…ë°© ì •ë³´ ë¡œë“œ
        // ============================================
        async function loadChatRoom() {
            try {
                const chatDocRef = doc(db, 'chats', chatId);
                const chatSnap = await getDoc(chatDocRef);
                
                if (!chatSnap.exists()) {
                    console.error('âŒ ì±„íŒ…ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    alert('ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }
                
                chatData = chatSnap.data();
                console.log('âœ… ì±„íŒ…ë°© ì •ë³´ ë¡œë“œ:', chatData);
                
                // participants ë°°ì—´ë¡œ ê¶Œí•œ ì²´í¬ (ì—†ìœ¼ë©´ buyerId/sellerIdë¡œ í´ë°±)
                const participants = chatData.participants || 
                    [chatData.buyerId, chatData.sellerId].filter(Boolean);
                
                const isParticipant = participants.includes(currentUser.uid) ||
                    chatData.buyerId === currentUser.uid ||
                    chatData.sellerId === currentUser.uid;
                
                if (!isParticipant) {
                    console.error('âŒ ì±„íŒ… ì°¸ì—¬ìê°€ ì•„ë‹™ë‹ˆë‹¤.');
                    alert('ì±„íŒ… ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }
                
                const otherUserId = participants.find(id => id !== currentUser.uid)
                    || (chatData.buyerId === currentUser.uid ? chatData.sellerId : chatData.buyerId);
                
                if (otherUserId) {
                    await loadOtherUserInfo(otherUserId);
                } else {
                    console.error('âŒ ìƒëŒ€ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ìƒí’ˆ ì •ë³´ ë¡œë“œ
                if (chatData.productId) {
                    await loadProductInfo(chatData.productId);
                }
                
                // ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
                await markAsRead();
                
            } catch (error) {
                console.error('âŒ ì±„íŒ…ë°© ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = 'index.html';
            }
        }

        // ============================================
        // 3. ìƒëŒ€ë°© ì •ë³´ ë¡œë“œ
        // ============================================
        async function loadOtherUserInfo(userId) {
            try {
                const userDocRef = doc(db, 'users', userId);
                const userSnap = await getDoc(userDocRef);
                
                if (userSnap.exists()) {
                    otherUser = { id: userId, ...userSnap.data() };
                    console.log('âœ… ìƒëŒ€ë°© ì •ë³´ ë¡œë“œ:', otherUser);
                    
                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('otherUserName').textContent = otherUser.displayName || otherUser.username || otherUser.nickname || otherUser.email || 'ì‚¬ìš©ì';
                    document.getElementById('otherUserImg').src = otherUser.profileImage || otherUser.photoURL || 'data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%20viewBox%3D%220%200%2040%2040%22%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2220%22%20r%3D%2220%22%20fill%3D%22%2310b981%22%2F%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2215%22%20r%3D%228%22%20fill%3D%22white%22%2F%3E%3Cellipse%20cx%3D%2220%22%20cy%3D%2235%22%20rx%3D%2212%22%20ry%3D%228%22%20fill%3D%22white%22%2F%3E%3C%2Fsvg%3E';
                    
                    // ì´ë¯¸ì§€ ì—ëŸ¬ ì²˜ë¦¬
                    document.getElementById('otherUserImg').onerror = function() {
                        this.src = 'data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2240%22%20height%3D%2240%22%20viewBox%3D%220%200%2040%2040%22%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2220%22%20r%3D%2220%22%20fill%3D%22%2310b981%22%2F%3E%3Ccircle%20cx%3D%2220%22%20cy%3D%2215%22%20r%3D%228%22%20fill%3D%22white%22%2F%3E%3Cellipse%20cx%3D%2220%22%20cy%3D%2235%22%20rx%3D%2212%22%20ry%3D%228%22%20fill%3D%22white%22%2F%3E%3C%2Fsvg%3E';
                    };
                    
                    // ì˜¨ë¼ì¸ ìƒíƒœ í‘œì‹œ
                    updateOnlineStatus(otherUser);
                } else {
                    console.log('âš ï¸ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    document.getElementById('otherUserName').textContent = 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì';
                }
            } catch (error) {
                console.error('âŒ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('otherUserName').textContent = 'ì‚¬ìš©ì';
            }
        }

        // ============================================
        // 3-1. ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
        // ============================================
        async function markAsRead() {
            if (!currentUser || !chatId) return;
            
            try {
                const chatDocRef = doc(db, 'chats', chatId);
                
                // í˜„ì¬ ì‚¬ìš©ìì˜ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                await updateDoc(chatDocRef, {
                    [`unreadCount.${currentUser.uid}`]: 0
                });
                
                console.log('âœ… ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            } catch (error) {
                console.error('âš ï¸ ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ê°€ ë‚˜ë„ ì±„íŒ…ì€ ê³„ì† ì§„í–‰
            }
        }

        // ============================================
        // 4. ìƒí’ˆ ì •ë³´ ë¡œë“œ
        // ============================================
        async function loadProductInfo(productId) {
            if (!productId) {
                console.log('âš ï¸ ìƒí’ˆ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const productDocRef = doc(db, 'products', productId);
                const productSnap = await getDoc(productDocRef);
                
                if (productSnap.exists()) {
                    const product = productSnap.data();
                    console.log('âœ… ìƒí’ˆ ì •ë³´ ë¡œë“œ:', product);
                    
                    const price = product.price === 0 ? 'ë‚˜ëˆ” ğŸŒ±' : `${(product.price || 0).toLocaleString()}ì›`;
                    
                    document.getElementById('productTitle').textContent = product.title || 'ìƒí’ˆ';
                    document.getElementById('productPrice').textContent = price;
                    document.getElementById('productImg').src = product.images?.[0] || 'data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%23e8f5e9%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-size%3D%2260%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3E%F0%9F%8C%BF%3C%2Ftext%3E%3C%2Fsvg%3E';
                    
                    // ìƒí’ˆ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                    document.getElementById('productImg').onclick = () => {
                        window.location.href = `product-detail.html?id=${productId}`;
                    };
                } else {
                    console.log('âš ï¸ ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ ìƒí’ˆ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ============================================
        // 5. ë©”ì‹œì§€ ì‹¤ì‹œê°„ ìˆ˜ì‹ 
        // ============================================
        function listenToMessages() {
            const messagesRef = collection(db, 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'));

            // âœ… BUG FIX #2: isInitialLoad + docChanges() ì¡°í•© ì œê±°
            //    â†’ í•­ìƒ ì „ì²´ ì¬ë Œë”ë§ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
            //    ì´ìœ : serverTimestamp() íœë”© ìƒíƒœì—ì„œ added/modified ì´ì¤‘ ë°œí™” íƒ€ì´ë° ë²„ê·¸
            //          ì‹¤ì œ ì±„íŒ… ë©”ì‹œì§€ëŠ” ë§ì§€ ì•Šìœ¼ë¯€ë¡œ ì „ì²´ ì¬ë Œë”ë§ì´ ë” ì•ˆì •ì 
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const chatContainer = document.getElementById('chatMessages');

                // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ê¸°ì–µ (ë§¨ ì•„ë˜ ìˆì—ˆìœ¼ë©´ ì¬ë Œë” í›„ì—ë„ ë§¨ ì•„ë˜ ìœ ì§€)
                const wasAtBottom = chatContainer.scrollHeight - chatContainer.scrollTop 
                                    <= chatContainer.clientHeight + 80;

                // ì „ì²´ ì¬ë Œë”ë§
                chatContainer.innerHTML = '';
                snapshot.docs.forEach((doc) => {
                    const messageData = doc.data();
                    const messageElement = createMessageElement(doc.id, messageData);
                    chatContainer.appendChild(messageElement);
                });

                if (wasAtBottom) scrollToBottom();

                console.log(`âœ… ë©”ì‹œì§€ ${snapshot.docs.length}ê°œ ë Œë”ë§`);

            }, (error) => {
                console.error('âŒ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹¤íŒ¨:', error);
                if (error.code === 'permission-denied') {
                    alert('ë©”ì‹œì§€ë¥¼ ë³¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                }
            });
        }

        // ============================================
        // 6. ë©”ì‹œì§€ UI ìƒì„±
        // ============================================
        function createMessageElement(messageId, data) {
            const isMyMessage = data.senderId === currentUser.uid;
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isMyMessage ? 'justify-end' : 'justify-start'}`;
            messageDiv.setAttribute('data-message-id', messageId);
            
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì²˜ë¦¬
            if (data.type === 'system') {
                messageDiv.innerHTML = `
                    <div class="w-full text-center">
                        <span class="inline-block bg-gray-200 text-gray-600 text-xs px-3 py-1 rounded-full">
                            ${escapeHtml(data.text || '')}
                        </span>
                    </div>
                `;
                return messageDiv;
            }
            
            let messageContent = '';
            
            // í…ìŠ¤íŠ¸ ë©”ì‹œì§€
            if (data.text) {
                // ë§í¬ ìë™ ê°ì§€ ë° ë³€í™˜ (ì„ íƒ ì‚¬í•­)
                const textWithLinks = escapeHtml(data.text).replace(
                    /(https?:\/\/[^\s]+)/g, 
                    '<a href="$1" target="_blank" class="underline">$1</a>'
                );
                messageContent = `<p class="break-words whitespace-pre-wrap">${textWithLinks}</p>`;
            }
            
            // ì´ë¯¸ì§€ ë©”ì‹œì§€
            if (data.imageUrl) {
                messageContent += `
                    <img src="${escapeHtml(data.imageUrl)}" 
                         class="image-message" 
                         onclick="showImageModal('${escapeHtml(data.imageUrl)}')"
                         onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20200%20200%22%3E%3Crect%20width%3D%22200%22%20height%3D%22200%22%20fill%3D%22%23f3f4f6%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20font-size%3D%2240%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3E%E2%9D%8C%3C%2Ftext%3E%3C%2Fsvg%3E'"
                         loading="lazy">
                `;
            }
            
            // ì¼ë°˜ ë©”ì‹œì§€
            const senderName = isMyMessage ? 'ë‚˜' : (otherUser?.displayName || otherUser?.username || otherUser?.nickname || otherUser?.email || 'ì‚¬ìš©ì');
            
            messageDiv.innerHTML = `
                <div class="flex flex-col ${isMyMessage ? 'items-end' : 'items-start'} max-w-[75%]">
                    ${!isMyMessage ? `<span class="text-xs text-gray-500 mb-1 ml-1">${escapeHtml(senderName)}</span>` : ''}
                    <div class="message-bubble ${isMyMessage ? 'my-message' : 'other-message'}">
                        ${messageContent}
                        ${isMyMessage ? `
                            <div class="message-menu">
                                <button onclick="toggleMessageMenu(event, '${messageId}')" class="text-white hover:text-gray-200 text-sm">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <span class="text-[10px] text-gray-400 mt-1 mx-1">
                        ${formatTimestamp(data.timestamp)}
                    </span>
                </div>
            `;
            
            return messageDiv;
        }

        // ============================================
        // 7. ë©”ì‹œì§€ ì „ì†¡
        // ============================================
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            if (!text && !selectedFile) {
                console.log('âš ï¸ ì „ì†¡í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // âœ… BUG FIX #2: ì „ì†¡ ì¤‘ ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ ì „ì†¡ ë°©ì§€)
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) { sendBtn.disabled = true; sendBtn.style.opacity = '0.5'; }
            
            try {
                const messageData = {
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email || 'ìµëª…',
                    timestamp: serverTimestamp(),
                    type: 'text'
                };
                
                // í…ìŠ¤íŠ¸ ì¶”ê°€
                if (text) {
                    messageData.text = text;
                }
                
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° URL ì¶”ê°€
                if (selectedFile) {
                    console.log('ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...');
                    const imageUrl = await uploadImage(selectedFile);
                    messageData.imageUrl = imageUrl;
                    messageData.type = text ? 'text' : 'image';
                    console.log('âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ:', imageUrl);
                }
                
                // Firestoreì— ë©”ì‹œì§€ ì¶”ê°€
                const messagesRef = collection(db, 'chats', chatId, 'messages');
                await addDoc(messagesRef, messageData);
                console.log('âœ… ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ');
                
                // ì±„íŒ…ë°©ì˜ lastMessage ë° ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
                const chatDocRef = doc(db, 'chats', chatId);
                const updateData = {
                    lastMessage: text || 'ì‚¬ì§„ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.',
                    lastMessageTime: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                // ìƒëŒ€ë°©ì˜ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì¦ê°€ (incrementë¡œ ë™ì‹œì„± ë¬¸ì œ ë°©ì§€)
                if (otherUser && otherUser.id) {
                    updateData[`unreadCount.${otherUser.id}`] = increment(1);
                }
                
                await updateDoc(chatDocRef, updateData);
                
                // ì…ë ¥ì°½ ì´ˆê¸°í™”
                messageInput.value = '';
                messageInput.style.height = 'auto';
                clearFilePreview();
                // âœ… BUG FIX #2: ì „ì†¡ ì™„ë£Œ í›„ ë²„íŠ¼ ë³µêµ¬
                if (sendBtn) { sendBtn.disabled = false; sendBtn.style.opacity = '1'; }
                
            } catch (error) {
                console.error('âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                // âœ… BUG FIX #2: ì‹¤íŒ¨ ì‹œì—ë„ ë²„íŠ¼ ë³µêµ¬
                if (sendBtn) { sendBtn.disabled = false; sendBtn.style.opacity = '1'; }
                
                if (error.code === 'permission-denied') {
                    alert('ë©”ì‹œì§€ ì „ì†¡ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            }
        }

        // ============================================
        // 8. ì´ë¯¸ì§€ ì—…ë¡œë“œ
        // ============================================
        async function uploadImage(file) {
            return new Promise((resolve, reject) => {
                try {
                    const fileName = `chat_images/${chatId}/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, fileName);
                    const uploadTask = uploadBytesResumable(storageRef, file);
                    
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log(`ğŸ“¤ ì—…ë¡œë“œ ì§„í–‰: ${progress.toFixed(0)}%`);
                            
                            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸ (ì„ íƒ ì‚¬í•­)
                            const preview = document.getElementById('filePreview');
                            if (preview && !preview.classList.contains('hidden')) {
                                preview.querySelector('.text-xs')?.insertAdjacentHTML('beforeend', 
                                    ` - ${progress.toFixed(0)}%`);
                            }
                        },
                        (error) => {
                            console.error('âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                            
                            if (error.code === 'storage/unauthorized') {
                                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                            } else if (error.code === 'storage/quota-exceeded') {
                                alert('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                            } else {
                                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            }
                            
                            reject(error);
                        },
                        async () => {
                            try {
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                console.log('âœ… ì´ë¯¸ì§€ URL:', downloadURL);
                                resolve(downloadURL);
                            } catch (error) {
                                console.error('âŒ URL ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                                reject(error);
                            }
                        }
                    );
                } catch (error) {
                    console.error('âŒ ì—…ë¡œë“œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    reject(error);
                }
            });
        }

        // ============================================
        // 9. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        // ============================================
        function setupEventListeners() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const fileInput = document.getElementById('fileInput');
            const attachBtn = document.getElementById('attachBtn');
            const menuBtn = document.getElementById('menuBtn');
            const dropdownMenu = document.getElementById('dropdownMenu');
            
            // ë©”ì‹œì§€ ì „ì†¡
            sendBtn.onclick = sendMessage;
            
            // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
            messageInput.onkeypress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };
            
            // í…ìŠ¤íŠ¸ ì…ë ¥ì°½ ìë™ ë†’ì´ ì¡°ì •
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // íŒŒì¼ ì²¨ë¶€ ë²„íŠ¼
            attachBtn.onclick = () => fileInput.click();
            
            // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
            fileInput.onchange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    selectedFile = e.target.files[0];
                    showFilePreview(selectedFile);
                }
            };
            
            // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í† ê¸€
            menuBtn.onclick = (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('show');
            };
            
            // ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener('click', () => {
                dropdownMenu.classList.remove('show');
            });
            
            // ê±°ë˜ ì˜ˆì•½ ë²„íŠ¼
            document.getElementById('dealBtn').onclick = () => {
                alert('ê±°ë˜ ì˜ˆì•½ ê¸°ëŠ¥ì´ ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.');
            };
        }

        // ============================================
        // 10. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        // ============================================
        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            setTimeout(() => {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function showFilePreview(file) {
            const preview = document.getElementById('filePreview');
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = `
                        <div class="flex items-center bg-white p-3 rounded-lg border">
                            <img src="${e.target.result}" class="w-16 h-16 object-cover rounded">
                            <div class="ml-3 flex-1">
                                <p class="text-sm font-medium text-gray-700 truncate">${file.name}</p>
                                <p class="text-xs text-gray-500">${(file.size / 1024).toFixed(2)} KB</p>
                            </div>
                            <button onclick="clearFilePreview()" class="text-gray-400 hover:text-red-500 ml-2">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // 1ë¶„ ë¯¸ë§Œ
            if (diff < 60000) return 'ë°©ê¸ˆ';
            
            // 1ì‹œê°„ ë¯¸ë§Œ
            if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return `${minutes}ë¶„ ì „`;
            }
            
            // ì˜¤ëŠ˜
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            }
            
            // ì–´ì œ
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return 'ì–´ì œ ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            }
            
            // ê·¸ ì™¸
            return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        }

        function updateOnlineStatus(user) {
            // ì‹¤ì œ ì˜¨ë¼ì¸ ìƒíƒœ êµ¬í˜„ ê°€ëŠ¥
            // ì˜ˆ: Realtime Databaseì˜ presence ì‹œìŠ¤í…œ í™œìš©
            document.getElementById('statusText').textContent = 'ì‘ë‹µ ë¹ ë¦„';
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // ============================================
        // 11. ì „ì—­ í•¨ìˆ˜ (window ê°ì²´ì— í• ë‹¹)
        // ============================================
        window.clearFilePreview = function() {
            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';
            preview.classList.add('hidden');
            document.getElementById('fileInput').value = '';
            selectedFile = null;
        };

        window.showImageModal = function(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModal').classList.remove('hidden');
            document.getElementById('imageModal').classList.add('flex');
        };

        window.closeImageModal = function() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageModal').classList.remove('flex');
            document.getElementById('modalImage').src = '';
        };

        window.toggleMessageMenu = function(event, messageId) {
            event.stopPropagation();
            // ë©”ì‹œì§€ ë©”ë‰´ êµ¬í˜„ (ë³µì‚¬, ì‚­ì œ ë“±)
            const menu = confirm('ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            if (menu) {
                deleteMessage(messageId);
            }
        };

        window.deleteMessage = async function(messageId) {
            try {
                const messageDocRef = doc(db, 'chats', chatId, 'messages', messageId);
                await deleteDoc(messageDocRef);
                console.log('âœ… ë©”ì‹œì§€ ì‚­ì œ ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨:', error);
                
                if (error.code === 'permission-denied') {
                    alert('ë©”ì‹œì§€ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    alert('ë©”ì‹œì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        };

        window.muteChat = function() {
            alert('ì•Œë¦¼ì´ êº¼ì¡ŒìŠµë‹ˆë‹¤.');
            document.getElementById('dropdownMenu').classList.remove('show');
        };

        window.searchChat = function() {
            alert('ëŒ€í™” ê²€ìƒ‰ ê¸°ëŠ¥ì´ ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.');
            document.getElementById('dropdownMenu').classList.remove('show');
        };

        window.leaveChat = function() {
            if (confirm('ì •ë§ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ë‚˜ê°€ë©´ ëŒ€í™” ë‚´ìš©ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
                alert('ì±„íŒ…ë°©ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.');
                history.back();
            }
            document.getElementById('dropdownMenu').classList.remove('show');
        };

        window.reportChat = function() {
            alert('ì‹ ê³  ê¸°ëŠ¥ì´ ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.');
            document.getElementById('dropdownMenu').classList.remove('show');
        };

        // ============================================
        // 12. í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        // ============================================
        window.addEventListener('beforeunload', () => {
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
        });
    </script>
</body>
</html>
