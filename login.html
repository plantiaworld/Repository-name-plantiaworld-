<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸ ë° íšŒì›ê°€ì… - PlantiaWorld</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .plant-bg {
            background-image: url('https://images.unsplash.com/photo-1545241047-6083a3684587?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80');
            background-size: cover; background-position: center;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        #map { height: 180px; border-radius: 12px; margin-top: 8px; border: 1px solid #ddd; z-index: 10; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="plant-bg min-h-screen flex items-center justify-center p-4 py-12">

    <div class="glass-card p-8 rounded-3xl shadow-2xl max-w-lg w-full">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i class="fas fa-leaf text-white text-2xl"></i>
            </div>
            <h1 id="pageTitle" class="text-2xl font-bold text-gray-800">PlantiaWorld ì‹œì‘í•˜ê¸°</h1>
            <p id="pageSubTitle" class="text-sm text-gray-500 mt-1">ì´ì›ƒê³¼ ì‹ë¬¼ì„ ë‚˜ëˆ„ëŠ” ì¦ê±°ì›€</p>
        </div>

        <form id="authForm" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-600 mb-1">ì´ë©”ì¼ ì£¼ì†Œ</label>
                <input type="email" id="email" class="w-full p-3 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-green-500" placeholder="example@email.com" required>
            </div>

            <div id="signupFields" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">ì„±í•¨</label>
                        <input type="text" id="realName" class="w-full p-3 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-green-500" placeholder="ë³¸ëª…">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">ë‹‰ë„¤ì„</label>
                        <input type="text" id="username" class="w-full p-3 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-green-500" placeholder="ë‹‰ë„¤ì„">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">í™œë™ ì§€ì—­ (ì§€ë„ í´ë¦­)</label>
                    <div id="map"></div>
                    <div class="mt-3 p-3 bg-green-50 rounded-xl flex items-center gap-2">
                        <i class="fas fa-map-marker-alt text-green-600"></i>
                        <p id="locationStatus" class="text-sm text-green-800 font-medium">ì§€ë„ë¥¼ í´ë¦­í•´ ì£¼ì„¸ìš”</p>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-600 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400"><i class="fas fa-lock"></i></span>
                    <input type="password" id="password" class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-green-500" placeholder="6ì ì´ìƒ ì…ë ¥" required>
                </div>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95 mt-4">
                ê°€ì… ì™„ë£Œ ë° ì‹œì‘í•˜ê¸°
            </button>
        </form>

        <div class="mt-6 text-center">
            <p id="toggleText" class="text-xs text-gray-400 font-medium">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button onclick="toggleMode()" class="text-green-600 underline focus:outline-none">ë¡œê·¸ì¸</button>
            </p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAW_z3hoI9SZ1-hoxKVYBKs7rbdo8n6wdc",
            authDomain: "plantiaworld.firebaseapp.com",
            projectId: "plantiaworld",
            storageBucket: "plantiaworld.appspot.com",
            messagingSenderId: "18112813073",
            appId: "1:18112813073:web:7247046c038a3831db79b0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isLoginMode = false; // í˜„ì¬ ëª¨ë“œ (íšŒì›ê°€ì…ì´ ê¸°ë³¸)

        // --- ëª¨ë“œ ì „í™˜ í•¨ìˆ˜ ---
        window.toggleMode = function() {
            isLoginMode = !isLoginMode;
            const signupFields = document.getElementById('signupFields');
            const submitBtn = document.getElementById('submitBtn');
            const pageTitle = document.getElementById('pageTitle');
            const toggleText = document.getElementById('toggleText');

            if (isLoginMode) {
                signupFields.classList.add('hidden');
                pageTitle.innerText = "ë‹¤ì‹œ ì˜¤ì…¨êµ°ìš”!";
                submitBtn.innerText = "ë¡œê·¸ì¸";
                toggleText.innerHTML = `ì²˜ìŒì´ì‹ ê°€ìš”? <button onclick="toggleMode()" class="text-green-600 underline focus:outline-none">íšŒì›ê°€ì…</button>`;
            } else {
                signupFields.classList.remove('hidden');
                pageTitle.innerText = "PlantiaWorld ì‹œì‘í•˜ê¸°";
                submitBtn.innerText = "ê°€ì… ì™„ë£Œ ë° ì‹œì‘í•˜ê¸°";
                toggleText.innerHTML = `ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button onclick="toggleMode()" class="text-green-600 underline focus:outline-none">ë¡œê·¸ì¸</button>`;
                map.invalidateSize(); // ì§€ë„ ê¹¨ì§ ë°©ì§€
            }
        };

        // --- ì§€ë„ ë¡œì§ ---
        let userLocation = { lat: 37.5665, lng: 126.9780, name: "ì„œìš¸íŠ¹ë³„ì‹œ" };
        const map = L.map('map').setView([userLocation.lat, userLocation.lng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker;

        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lng]).addTo(map);
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ko`)
                .then(res => res.json())
                .then(data => {
                    userLocation.name = data.display_name.split(',')[0] || "ì•Œ ìˆ˜ ì—†ëŠ” ìœ„ì¹˜";
                    userLocation.lat = lat; userLocation.lng = lng;
                    document.getElementById('locationStatus').innerText = `í˜„ì¬ ìœ„ì¹˜: ${userLocation.name}`;
                });
        });

        // --- ì¸ì¦ ì²˜ë¦¬ (ë¡œê·¸ì¸/íšŒì›ê°€ì… í†µí•©) ---
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            btn.disabled = true;
            btn.innerText = "ì²˜ë¦¬ ì¤‘...";

            try {
                if (isLoginMode) {
                    // [ë¡œê·¸ì¸ ë¡œì§]
                    await signInWithEmailAndPassword(auth, email, password);
                    alert("ì„±ê³µì ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸŒ±");
                    location.href = 'index.html';
                } else {
                    // [íšŒì›ê°€ì… ë¡œì§]
                    const nickname = document.getElementById('username').value;
                    const realName = document.getElementById('realName').value;
                    if (!marker) return alert('ì§€ë„ë¥¼ í´ë¦­í•´ í™œë™ ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”! ğŸ“');

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        uid: userCredential.user.uid,
                        email, nickname, realName,
                        location: userLocation.name,
                        lat: userLocation.lat, lng: userLocation.lng,
                        joinDate: new Date().toISOString()
                    });
                    alert(`ë°˜ê°‘ìŠµë‹ˆë‹¤, ${nickname}ë‹˜! íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    location.href = 'index.html';
                }
            } catch (error) {
                let msg = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                if (error.code === "auth/email-already-in-use") msg = "ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ ëª¨ë“œë¡œ ì „í™˜í•˜ì—¬ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.";
                else if (error.code === "auth/wrong-password") msg = "ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
                else if (error.code === "auth/user-not-found") msg = "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì…ë‹ˆë‹¤.";
                
                alert(msg);
                console.error(error);
                btn.disabled = false;
                btn.innerText = isLoginMode ? "ë¡œê·¸ì¸" : "ê°€ì… ì™„ë£Œ ë° ì‹œì‘í•˜ê¸°";
            }
        });

        // ì´ë¯¸ ë¡œê·¸ì¸ ëœ ìƒíƒœë©´ indexë¡œ ì´ë™
        onAuthStateChanged(auth, (user) => {
            if (user) location.href = 'index.html';
        });
    </script>
</body>
</html>