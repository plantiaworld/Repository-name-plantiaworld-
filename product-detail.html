<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ë¬¼ ìƒì„¸ ì •ë³´ - PlantiaWorld</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            updateDoc,
            deleteDoc,
            increment,
            arrayUnion,
            arrayRemove,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            limit,
            addDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
           apiKey: "AIzaSyAW_z3hoI9SZ1-hoxKVYBKs7rbdo8n6wdc",
           authDomain: "plantiaworld.firebaseapp.com",
           projectId: "plantiaworld",
           storageBucket: "plantiaworld.firebasestorage.app",
           messagingSenderId: "18112813073",
           appId: "1:18112813073:web:7247046c038a3831db79b0",
           measurementId: "G-8XSSM279KY"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ========== ì „ì—­ ë³€ìˆ˜ ==========
        let currentUser = null;
        let currentProduct = null;
        let productId = null;
        let currentSlideIndex = 0;
        let map = null;
        let mapMarker = null;
        let isDataLoaded = false;
        let unsubscribeProduct = null;

        window.firebaseModules = { db, auth };

        // ========== URLì—ì„œ ìƒí’ˆ ID ê°€ì ¸ì˜¤ê¸° ==========
        const urlParams = new URLSearchParams(window.location.search);
        productId = urlParams.get('id');

        if (!productId) {
            alert('ìƒí’ˆ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
            window.location.href = 'index.html';
            throw new Error('No product ID');
        }

        console.log('ğŸ” ìƒí’ˆ ID:', productId);

        // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==========
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'ë°©ê¸ˆ ì „';
            try {
                const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
                const now = new Date();
                const diff = Math.floor((now - date) / 1000);
                
                if (diff < 60) return 'ë°©ê¸ˆ ì „';
                if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
                if (diff < 604800) return `${Math.floor(diff / 86400)}ì¼ ì „`;
                return date.toLocaleDateString('ko-KR');
            } catch (error) {
                console.error('ë‚ ì§œ í¬ë§· ì˜¤ë¥˜:', error);
                return 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
        }

        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>
                ${escapeHtml(message)}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // ========== ì¸ì¦ ìƒíƒœ í™•ì¸ ==========
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            
            if (user) {
                console.log('âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:', user.uid);
            } else {
                console.log('ğŸ‘¤ ë¹„ë¡œê·¸ì¸ ìƒíƒœ');
            }
            
            if (!isDataLoaded) {
                await loadProductDetail();
                isDataLoaded = true;
            } else {
                if (currentProduct) {
                    updateOwnerActions();
                    updateLikeButton(currentProduct);
                }
            }
        });

        // ========== í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ë¦¬ìŠ¤ë„ˆ í•´ì œ ==========
        window.addEventListener('beforeunload', () => {
            if (unsubscribeProduct) {
                unsubscribeProduct();
            }
        });

        // ========== ìƒí’ˆ ìƒì„¸ ì •ë³´ ë¡œë“œ ==========
        async function loadProductDetail() {
            try {
                const productRef = doc(db, 'products', productId);
                let hasIncrementedView = false;
                
                console.log('ğŸ“¥ ìƒí’ˆ ë¡œë“œ ì‹œì‘...');
                
                unsubscribeProduct = onSnapshot(productRef, async (snapshot) => {
                    if (snapshot.exists()) {
                        const prevProduct = currentProduct;
                        currentProduct = { id: snapshot.id, ...snapshot.data() };
                        
                        console.log('âœ… ìƒí’ˆ ë°ì´í„°:', currentProduct);
                        
                        // ì¡°íšŒìˆ˜ ì¦ê°€ (ìµœì´ˆ í•œ ë²ˆë§Œ)
                        if (!hasIncrementedView && !sessionStorage.getItem(`viewed_${productId}`)) {
                            hasIncrementedView = true;
                            try {
                                await updateDoc(productRef, { views: increment(1) });
                                sessionStorage.setItem(`viewed_${productId}`, 'true');
                                console.log('ğŸ‘ï¸ ì¡°íšŒìˆ˜ ì¦ê°€ ì™„ë£Œ');
                            } catch (error) {
                                console.error('âŒ ì¡°íšŒìˆ˜ ì¦ê°€ ì˜¤ë¥˜:', error);
                            }
                        }
                        
                        // UI ì—…ë°ì´íŠ¸
                        updateProductUI(currentProduct);
                        
                        // íŒë§¤ì ì •ë³´ ë¡œë“œ
                        if (!prevProduct || prevProduct.sellerId !== currentProduct.sellerId) {
                            console.log('ğŸ‘¤ íŒë§¤ì ì •ë³´ ë¡œë“œ ì‹œì‘:', currentProduct.sellerId);
                            await loadSellerInfo(currentProduct.sellerId);
                            await loadSellerOtherProducts(currentProduct.sellerId);
                        }
                        
                        // ìœ ì‚¬ ìƒí’ˆ ë¡œë“œ
                        if (!prevProduct) {
                            await loadSimilarProducts();
                        }
                        
                        // ë¡œë”© í™”ë©´ ìˆ¨ê¹€
                        const loadingScreen = document.getElementById('loadingScreen');
                        if (loadingScreen) {
                            loadingScreen.classList.add('hidden');
                        }
                    } else {
                        console.error('âŒ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        showProductNotFound();
                    }
                }, (error) => {
                    console.error('âŒ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
                    showProductNotFound();
                });
                
            } catch (error) {
                console.error('âŒ ìƒí’ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
                showProductNotFound();
            }
        }

        // ========== UI ì—…ë°ì´íŠ¸ ==========
        function updateProductUI(product) {
            if (!product) return;
            
            console.log('ğŸ¨ UI ì—…ë°ì´íŠ¸ ì‹œì‘');
            
            // ì œëª©ê³¼ ì„¤ëª…
            const titleEl = document.getElementById('productTitle');
            const descEl = document.getElementById('productDescription');
            const categoryEl = document.getElementById('productCategory');
            const dateEl = document.getElementById('productDate');
            
            if (titleEl) titleEl.textContent = product.title || 'ì œëª© ì—†ìŒ';
            if (descEl) descEl.textContent = product.description || 'ìƒí’ˆ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
            if (categoryEl) categoryEl.textContent = product.category || 'ê¸°íƒ€';
            if (dateEl) dateEl.textContent = formatDate(product.createdAt || product.createdDate);
            
            // ê°€ê²©
            const priceEl = document.getElementById('productPrice');
            const priceInfoEl = document.getElementById('priceInfo');
            const price = product.price || 0;
            
            if (priceEl && priceInfoEl) {
                if (price === 0) {
                    priceEl.textContent = 'ë‚˜ëˆ” ğŸŒ±';
                    priceEl.className = 'text-2xl font-bold text-green-600';
                    priceInfoEl.textContent = 'ë¬´ë£Œ ë‚˜ëˆ”';
                } else {
                    priceEl.textContent = price.toLocaleString() + 'ì›';
                    priceEl.className = 'text-2xl font-bold text-gray-900';
                    priceInfoEl.textContent = 'ê°€ê²© í˜‘ì˜ ê°€ëŠ¥';
                }
            }
            
            // ìƒíƒœ ë°°ì§€
            const statusBadge = document.getElementById('statusBadge');
            if (statusBadge) {
                const status = product.status || 'íŒë§¤ì¤‘';
                statusBadge.textContent = status;
                
                let badgeClass = 'px-3 py-1 rounded-full text-sm font-bold ';
                switch(status) {
                    case 'íŒë§¤ì¤‘':
                        badgeClass += 'bg-blue-100 text-blue-800';
                        break;
                    case 'ì˜ˆì•½ì¤‘':
                        badgeClass += 'bg-orange-100 text-orange-800';
                        break;
                    case 'íŒë§¤ì™„ë£Œ':
                        badgeClass += 'bg-red-100 text-red-800';
                        break;
                    default:
                        badgeClass += 'bg-gray-100 text-gray-800';
                }
                statusBadge.className = badgeClass;
            }
            
            // í†µê³„
            const viewCountEl = document.getElementById('viewCount');
            const likeCountEl = document.getElementById('likeCount');
            const chatCountEl = document.getElementById('chatCount');
            
            if (viewCountEl) viewCountEl.textContent = (product.views || 0).toLocaleString();
            if (likeCountEl) likeCountEl.textContent = (product.likes?.length || 0).toLocaleString();
            if (chatCountEl) chatCountEl.textContent = (product.chatCount || 0).toLocaleString();
            
            // ìœ„ì¹˜ ì •ë³´
            const locationEl = document.getElementById('productLocation');
            if (locationEl) {
                const location = product.sellerLocation || product.location?.address || product.location || 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ';
                locationEl.textContent = typeof location === 'string' ? location : 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ';
            }
            
            // ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë”
            updateImageSlider(product.images || []);
            
            // ì†Œìœ ì ì•¡ì…˜
            updateOwnerActions();
            
            // ì¢‹ì•„ìš” ë²„íŠ¼
            updateLikeButton(product);
            
            // ì§€ë„ í‘œì‹œ (ë‹¤ì–‘í•œ í•„ë“œëª… ì§€ì›)
            const tradeLocation = product.tradeLocation || product.location;
            if (tradeLocation) {
                const lat = tradeLocation.lat || tradeLocation.latitude;
                const lng = tradeLocation.lng || tradeLocation.longitude;
                
                if (lat && lng) {
                    console.log('ğŸ—ºï¸ ì§€ë„ í‘œì‹œ:', { lat, lng });
                    setTimeout(() => initializeMap({ lat, lng, address: tradeLocation.address }), 300);
                } else {
                    console.log('âš ï¸ ì§€ë„ ì¢Œí‘œ ì—†ìŒ');
                    const mapContainer = document.getElementById('mapContainer');
                    if (mapContainer) mapContainer.classList.add('hidden');
                }
            } else {
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer) mapContainer.classList.add('hidden');
            }
            
            console.log('âœ… UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }

        // ========== ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸ ==========
        function updateImageSlider(images) {
            const container = document.getElementById('imageSlider');
            const indicators = document.getElementById('indicators');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (!container) return;
            
            currentSlideIndex = 0;
            
            if (!images || images.length === 0) {
                container.innerHTML = `
                    <div class="w-full h-full flex items-center justify-center bg-gray-100">
                        <i class="fas fa-leaf text-6xl text-gray-300"></i>
                    </div>
                `;
                if (indicators) indicators.innerHTML = '';
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
                return;
            }
            
            container.innerHTML = images.map((img, idx) => `
                <div class="slide ${idx === 0 ? 'active' : ''}" style="background-image: url('${escapeHtml(img)}')"></div>
            `).join('');
            
            if (indicators) {
                indicators.innerHTML = images.map((_, idx) => `
                    <span class="indicator ${idx === 0 ? 'active' : ''}" onclick="goToSlide(${idx})"></span>
                `).join('');
            }
            
            if (prevBtn) prevBtn.style.display = images.length > 1 ? 'flex' : 'none';
            if (nextBtn) nextBtn.style.display = images.length > 1 ? 'flex' : 'none';
            
            console.log('ğŸ“· ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸:', images.length, 'ê°œ');
        }

        // ========== ìŠ¬ë¼ì´ë” ë„¤ë¹„ê²Œì´ì…˜ ==========
        window.prevSlide = function() {
            const slides = document.querySelectorAll('.slide');
            const indicators = document.querySelectorAll('.indicator');
            if (slides.length === 0) return;
            
            currentSlideIndex = (currentSlideIndex - 1 + slides.length) % slides.length;
            
            slides.forEach((slide, idx) => {
                slide.classList.toggle('active', idx === currentSlideIndex);
            });
            indicators.forEach((ind, idx) => {
                ind.classList.toggle('active', idx === currentSlideIndex);
            });
        };

        window.nextSlide = function() {
            const slides = document.querySelectorAll('.slide');
            const indicators = document.querySelectorAll('.indicator');
            if (slides.length === 0) return;
            
            currentSlideIndex = (currentSlideIndex + 1) % slides.length;
            
            slides.forEach((slide, idx) => {
                slide.classList.toggle('active', idx === currentSlideIndex);
            });
            indicators.forEach((ind, idx) => {
                ind.classList.toggle('active', idx === currentSlideIndex);
            });
        };

        window.goToSlide = function(index) {
            const slides = document.querySelectorAll('.slide');
            const indicators = document.querySelectorAll('.indicator');
            
            currentSlideIndex = index;
            
            slides.forEach((slide, idx) => {
                slide.classList.toggle('active', idx === currentSlideIndex);
            });
            indicators.forEach((ind, idx) => {
                ind.classList.toggle('active', idx === currentSlideIndex);
            });
        };

        // ========== íŒë§¤ì ì •ë³´ ë¡œë“œ (ê°œì„ ë¨) ==========
        async function loadSellerInfo(sellerId) {
            console.log('ğŸ‘¤ íŒë§¤ì ì •ë³´ ë¡œë“œ:', sellerId);
            
            const sellerNameEl = document.getElementById('sellerName');
            const sellerAvatarEl = document.getElementById('sellerAvatar');
            const sellerJoinDateEl = document.getElementById('sellerJoinDate');
            
            if (!sellerId) {
                console.warn('âš ï¸ íŒë§¤ì ID ì—†ìŒ');
                if (sellerNameEl) sellerNameEl.textContent = 'ì•Œ ìˆ˜ ì—†ëŠ” íŒë§¤ì';
                if (sellerAvatarEl) sellerAvatarEl.src = 'https://via.placeholder.com/50?text=?';
                if (sellerJoinDateEl) sellerJoinDateEl.textContent = '-';
                return;
            }
            
            try {
                const userRef = doc(db, 'users', sellerId);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    const seller = userSnap.data();
                    console.log('âœ… íŒë§¤ì ì •ë³´ ë¡œë“œ ì„±ê³µ:', seller);
                    
                    if (sellerNameEl) {
                        sellerNameEl.textContent = seller.displayName || seller.nickname || seller.name || 'ì‚¬ìš©ì';
                    }
                    
                    if (sellerAvatarEl) {
                        sellerAvatarEl.src = seller.photoURL || 'https://via.placeholder.com/50?text=' + (seller.displayName?.[0] || '?');
                        sellerAvatarEl.onerror = () => {
                            sellerAvatarEl.src = 'https://via.placeholder.com/50?text=?';
                        };
                    }
                    
                    if (sellerJoinDateEl) {
                        const joinDate = seller.createdAt 
                            ? new Date(seller.createdAt.seconds * 1000).toLocaleDateString('ko-KR')
                            : '-';
                        sellerJoinDateEl.textContent = joinDate;
                    }
                } else {
                    console.warn('âš ï¸ íŒë§¤ì ì •ë³´ ì—†ìŒ (íƒˆí‡´í•œ ì‚¬ìš©ìì¼ ìˆ˜ ìˆìŒ)');
                    if (sellerNameEl) sellerNameEl.textContent = 'íƒˆí‡´í•œ ì‚¬ìš©ì';
                    if (sellerAvatarEl) sellerAvatarEl.src = 'https://via.placeholder.com/50?text=X';
                    if (sellerJoinDateEl) sellerJoinDateEl.textContent = '-';
                }
            } catch (error) {
                console.error('âŒ íŒë§¤ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                if (sellerNameEl) sellerNameEl.textContent = 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŒ';
                if (sellerAvatarEl) sellerAvatarEl.src = 'https://via.placeholder.com/50?text=!';
                if (sellerJoinDateEl) sellerJoinDateEl.textContent = '-';
            }
        }

        // ========== íŒë§¤ì ë‹¤ë¥¸ ìƒí’ˆ ë¡œë“œ ==========
        async function loadSellerOtherProducts(sellerId) {
            const container = document.getElementById('sellerOtherProducts');
            if (!container || !sellerId) return;
            
            container.innerHTML = '<p class="col-span-full text-center text-gray-500">ë¡œë”© ì¤‘...</p>';
            
            try {
                const q = query(
                    collection(db, 'products'),
                    where('sellerId', '==', sellerId),
                    where('status', '==', 'íŒë§¤ì¤‘'),
                    limit(5)
                );
                
                const snapshot = await getDocs(q);
                const products = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(p => p.id !== productId);
                
                if (products.length === 0) {
                    container.innerHTML = '<p class="col-span-full text-center text-gray-500">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>';
                    return;
                }
                
                container.innerHTML = products.map(product => {
                    const image = product.images?.[0] || 'https://via.placeholder.com/200?text=No+Image';
                    const price = product.price === 0 ? 'ë‚˜ëˆ” ğŸŒ±' : `${product.price.toLocaleString()}ì›`;
                    const title = product.title || 'ì œëª© ì—†ìŒ';
                    const location = product.sellerLocation || product.location?.address || 'ì§€ì—­ ì •ë³´ ì—†ìŒ';
                    
                    return `
                        <a href="product-detail.html?id=${product.id}" class="product-card">
                            <div class="product-image" style="background-image: url('${escapeHtml(image)}')"></div>
                            <div class="p-3">
                                <h4 class="font-bold text-gray-800 mb-1 truncate">${escapeHtml(title)}</h4>
                                <p class="text-green-600 font-bold">${price}</p>
                                <p class="text-xs text-gray-500 mt-1">${escapeHtml(typeof location === 'string' ? location : 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ')}</p>
                            </div>
                        </a>
                    `;
                }).join('');
                
                console.log('âœ… íŒë§¤ì ìƒí’ˆ ë¡œë“œ ì™„ë£Œ:', products.length, 'ê°œ');
            } catch (error) {
                console.error('âŒ íŒë§¤ì ìƒí’ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
                container.innerHTML = '<p class="col-span-full text-center text-red-500">ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }

        // ========== ìœ ì‚¬ ìƒí’ˆ ë¡œë“œ ==========
        async function loadSimilarProducts() {
            const container = document.getElementById('similarProducts');
            if (!container) return;
            
            container.innerHTML = '<p class="col-span-full text-center text-gray-500">ë¡œë”© ì¤‘...</p>';
            
            try {
                const q = query(
                    collection(db, 'products'),
                    where('category', '==', currentProduct.category || 'ê¸°íƒ€'),
                    where('status', '==', 'íŒë§¤ì¤‘'),
                    limit(9)
                );
                
                const snapshot = await getDocs(q);
                const products = snapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(p => p.id !== productId);
                
                if (products.length === 0) {
                    container.innerHTML = '<p class="col-span-full text-center text-gray-500">ì¶”ì²œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</p>';
                    return;
                }
                
                container.innerHTML = products.slice(0, 8).map(product => {
                    const image = product.images?.[0] || 'https://via.placeholder.com/200?text=No+Image';
                    const price = product.price === 0 ? 'ë‚˜ëˆ” ğŸŒ±' : `${product.price.toLocaleString()}ì›`;
                    const title = product.title || 'ì œëª© ì—†ìŒ';
                    const location = product.sellerLocation || product.location?.address || 'ì§€ì—­ ì •ë³´ ì—†ìŒ';
                    
                    return `
                        <a href="product-detail.html?id=${product.id}" class="product-card">
                            <div class="product-image" style="background-image: url('${escapeHtml(image)}')"></div>
                            <div class="p-3">
                                <h4 class="font-bold text-gray-800 mb-1 truncate">${escapeHtml(title)}</h4>
                                <p class="text-green-600 font-bold">${price}</p>
                                <p class="text-xs text-gray-500 mt-1">${escapeHtml(typeof location === 'string' ? location : 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ')}</p>
                            </div>
                        </a>
                    `;
                }).join('');
                
                console.log('âœ… ìœ ì‚¬ ìƒí’ˆ ë¡œë“œ ì™„ë£Œ:', products.length, 'ê°œ');
            } catch (error) {
                console.error('âŒ ìœ ì‚¬ ìƒí’ˆ ë¡œë“œ ì˜¤ë¥˜:', error);
                container.innerHTML = '<p class="col-span-full text-center text-red-500">ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }

        // ========== ì§€ë„ ì´ˆê¸°í™” ==========
        function initializeMap(location) {
            if (!location || !location.lat || !location.lng) {
                console.warn('âš ï¸ ì§€ë„ ì¢Œí‘œ ì—†ìŒ');
                return;
            }
            
            try {
                const mapContainer = document.getElementById('mapContainer');
                const mapDiv = document.getElementById('tradeMap');
                
                if (!mapContainer || !mapDiv) {
                    console.warn('âš ï¸ ì§€ë„ ì—˜ë¦¬ë¨¼íŠ¸ ì—†ìŒ');
                    return;
                }
                
                mapContainer.classList.remove('hidden');
                
                if (!map) {
                    console.log('ğŸ—ºï¸ ì§€ë„ ìµœì´ˆ ìƒì„±');
                    map = L.map('tradeMap').setView([location.lat, location.lng], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(map);
                } else {
                    console.log('ğŸ—ºï¸ ì§€ë„ ìœ„ì¹˜ ì—…ë°ì´íŠ¸');
                    map.setView([location.lat, location.lng], 15);
                }
                
                // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                if (mapMarker) {
                    map.removeLayer(mapMarker);
                }
                
                // ìƒˆ ë§ˆì»¤ ì¶”ê°€
                mapMarker = L.marker([location.lat, location.lng]).addTo(map)
                    .bindPopup(escapeHtml(location.address || 'ê±°ë˜ í¬ë§ ì¥ì†Œ'))
                    .openPopup();
                
                // ì§€ë„ í¬ê¸° ì¬ì¡°ì •
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
                
                console.log('âœ… ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        // ========== ì¢‹ì•„ìš” ê¸°ëŠ¥ ==========
        function updateLikeButton(product) {
            const likeIcon = document.getElementById('likeIcon');
            if (!likeIcon || !product) return;
            
            const isLiked = currentUser && product.likes?.includes(currentUser.uid);
            likeIcon.className = isLiked 
                ? 'fas fa-heart text-red-500 text-xl' 
                : 'far fa-heart text-gray-600 text-xl';
        }

        window.toggleLike = async function() {
            if (!currentUser) {
                if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    window.location.href = 'login.html';
                }
                return;
            }
            
            if (!currentProduct) {
                showToast('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            try {
                const productRef = doc(db, 'products', productId);
                const isLiked = currentProduct.likes?.includes(currentUser.uid);
                
                if (isLiked) {
                    await updateDoc(productRef, {
                        likes: arrayRemove(currentUser.uid)
                    });
                    showToast('ê´€ì‹¬ ëª©ë¡ì—ì„œ ì œê±°í–ˆìŠµë‹ˆë‹¤');
                } else {
                    await updateDoc(productRef, {
                        likes: arrayUnion(currentUser.uid)
                    });
                    showToast('ê´€ì‹¬ ëª©ë¡ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('âŒ ì¢‹ì•„ìš” ì˜¤ë¥˜:', error);
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        };

        // ========== ì†Œìœ ì ì•¡ì…˜ ì—…ë°ì´íŠ¸ ==========
        function updateOwnerActions() {
            const buyerActions = document.getElementById('buyerActions');
            const ownerActions = document.getElementById('ownerActions');
            
            if (!buyerActions || !ownerActions || !currentProduct) return;
            
            const isOwner = currentUser && currentUser.uid === currentProduct.sellerId;
            
            if (isOwner) {
                buyerActions.classList.add('hidden');
                ownerActions.classList.remove('hidden');
                console.log('ğŸ‘¤ ì†Œìœ ì ëª¨ë“œ');
            } else {
                buyerActions.classList.remove('hidden');
                ownerActions.classList.add('hidden');
                console.log('ğŸ‘¥ êµ¬ë§¤ì ëª¨ë“œ');
            }
        }

        // ========== ì±„íŒ… ì‹œì‘ ==========
        window.handleChatClick = async function() {
            if (!currentUser) {
                if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    window.location.href = 'login.html';
                }
                return;
            }
            
            if (!currentProduct) {
                showToast('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            if (currentUser.uid === currentProduct.sellerId) {
                showToast('ë³¸ì¸ì˜ ìƒí’ˆì…ë‹ˆë‹¤', 'error');
                return;
            }
            
            try {
                showToast('ì±„íŒ…ë°©ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...', 'success');
                
                const chatId = [currentUser.uid, currentProduct.sellerId].sort().join('_');
                const chatRef = doc(db, 'chats', chatId);
                const chatSnap = await getDoc(chatRef);
                
                if (!chatSnap.exists()) {
                    const chatData = {
                        participants: [currentUser.uid, currentProduct.sellerId],
                        buyerId: currentUser.uid,
                        sellerId: currentProduct.sellerId,
                        productId: currentProduct.id,
                        productTitle: currentProduct.title || 'ì œëª© ì—†ìŒ',
                        productImage: currentProduct.images?.[0] || '',
                        productPrice: currentProduct.price || 0,
                        lastMessage: '',
                        lastMessageTime: serverTimestamp(),
                        unreadCount: {
                            [currentUser.uid]: 0,
                            [currentProduct.sellerId]: 0
                        },
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };

                    await setDoc(chatRef, chatData);
                    console.log('âœ… ìƒˆ ì±„íŒ…ë°© ìƒì„±:', chatId);
                    
                    // ì±„íŒ… ìˆ˜ ì¦ê°€
                    try {
                        const productRef = doc(db, 'products', productId);
                        await updateDoc(productRef, {
                            chatCount: increment(1)
                        });
                    } catch (error) {
                        console.error('ì±„íŒ… ìˆ˜ ì¦ê°€ ì˜¤ë¥˜:', error);
                    }
                }
                
                // ì±„íŒ… í˜ì´ì§€ë¡œ ì´ë™ (ì˜¬ë°”ë¥¸ íŒŒì¼ëª…)
                window.location.href = `chat.html?id=${chatId}`;
            } catch (error) {
                console.error('âŒ ì±„íŒ… ì‹œì‘ ì˜¤ë¥˜:', error);
                showToast('ì±„íŒ…ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        };

        // ========== ìƒí’ˆ ìˆ˜ì • (ê°œì„ ë¨) ==========
        window.editProduct = function() {
            if (!currentProduct || !currentUser) {
                showToast('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            if (currentUser.uid !== currentProduct.sellerId) {
                showToast('ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            console.log('âœï¸ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™:', productId);
            
            // URL íŒŒë¼ë¯¸í„°ë¡œ ìƒí’ˆ ID ì „ë‹¬ (upload.htmlì—ì„œ ì²˜ë¦¬)
            window.location.href = `upload.html?edit=${productId}`;
        };

        // ========== ìƒí’ˆ ì‚­ì œ ==========
        window.deleteProduct = async function() {
            if (!currentProduct || !currentUser) {
                showToast('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            if (currentUser.uid !== currentProduct.sellerId) {
                showToast('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
            
            try {
                await deleteDoc(doc(db, 'products', productId));
                showToast('ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
            } catch (error) {
                console.error('âŒ ì‚­ì œ ì˜¤ë¥˜:', error);
                showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        };

        // ========== ìƒíƒœ ë³€ê²½ ==========
        window.openStatusModal = function() {
            document.getElementById('statusModal').classList.remove('hidden');
        };

        window.closeStatusModal = function() {
            document.getElementById('statusModal').classList.add('hidden');
        };

        window.changeStatus = async function(newStatus) {
            if (!currentProduct) {
                showToast('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            try {
                const productRef = doc(db, 'products', productId);
                await updateDoc(productRef, {
                    status: newStatus,
                    updatedAt: serverTimestamp()
                });
                
                closeStatusModal();
                showToast(`ìƒíƒœê°€ "${newStatus}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`);
            } catch (error) {
                console.error('âŒ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                showToast('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        };

        // ========== ì‹ ê³  ê¸°ëŠ¥ ==========
        window.openReportModal = function() {
            if (!currentUser) {
                if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    window.location.href = 'login.html';
                }
                return;
            }
            
            document.getElementById('reportReason').value = '';
            document.getElementById('reportDetails').value = '';
            document.getElementById('reportModal').classList.remove('hidden');
        };

        window.closeReportModal = function() {
            document.getElementById('reportModal').classList.add('hidden');
        };

        window.submitReport = async function() {
            if (!currentUser || !currentProduct) {
                showToast('ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            const reason = document.getElementById('reportReason').value;
            const details = document.getElementById('reportDetails').value.trim();
            
            if (!reason) {
                showToast('ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            if (!details) {
                showToast('ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            try {
                await addDoc(collection(db, 'reports'), {
                    productId: productId,
                    productTitle: currentProduct.title,
                    reporterId: currentUser.uid,
                    sellerId: currentProduct.sellerId,
                    reason: reason,
                    details: details,
                    createdAt: serverTimestamp(),
                    status: 'pending'
                });
                
                closeReportModal();
                showToast('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤');
            } catch (error) {
                console.error('âŒ ì‹ ê³  ì˜¤ë¥˜:', error);
                showToast('ì‹ ê³ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        };

        window.blockUser = async function() {
            if (!currentUser || !currentProduct) {
                showToast('ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            if (!confirm('ì´ ì‚¬ìš©ìì˜ ê²Œì‹œê¸€ì„ ë” ì´ìƒ ë³´ì§€ ì•Šìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    blockedUsers: arrayUnion(currentProduct.sellerId)
                });
                
                showToast('ì‚¬ìš©ìë¥¼ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤');
                setTimeout(() => window.location.href = 'index.html', 1500);
            } catch (error) {
                console.error('âŒ ì°¨ë‹¨ ì˜¤ë¥˜:', error);
                showToast('ì°¨ë‹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
        };

        // ========== ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ì„ ë•Œ ==========
        function showProductNotFound() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.innerHTML = `
                    <div class="text-center p-8">
                        <i class="fas fa-exclamation-triangle text-6xl text-yellow-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
                        <p class="text-gray-600 mb-6">ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìƒí’ˆì…ë‹ˆë‹¤</p>
                        <button onclick="window.location.href='index.html'" 
                                class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition">
                            ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                `;
                loadingScreen.classList.remove('hidden');
            }
        }

        // ========== ë’¤ë¡œê°€ê¸° ==========
        window.goBack = function() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        };
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* ë¡œë”© í™”ë©´ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e5e7eb;
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” */
        .image-slider-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 1rem;
            overflow: hidden;
            background: #f3f4f6;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .slide.active {
            opacity: 1;
            z-index: 1;
        }

        .slider-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s;
        }

        .slider-btn:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
        }

        .slider-btn.prev {
            left: 10px;
        }

        .slider-btn.next {
            right: 10px;
        }

        .indicators {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .indicator.active {
            background: white;
            width: 30px;
            border-radius: 5px;
        }

        /* ìƒí’ˆ ì¹´ë“œ */
        .product-card {
            display: block;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .product-image {
            width: 100%;
            padding-top: 100%;
            background-size: cover;
            background-position: center;
            background-color: #f3f4f6;
        }

        /* í•˜ë‹¨ ê³ ì • ë°” */
        .floating-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        /* ëª¨ë‹¬ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* ì§€ë„ */
        #tradeMap {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
        }

        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 3000;
            display: flex;
            align-items: center;
            animation: slideUp 0.3s ease;
            min-width: 250px;
            justify-content: center;
        }

        .toast-success {
            background: #10b981;
        }

        .toast-error {
            background: #ef4444;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 20px);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .image-slider-container {
                height: 300px;
            }
            
            body {
                padding-bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container mx-auto max-w-4xl px-4 py-6">
        <!-- ìƒë‹¨ í—¤ë” -->
        <div class="flex items-center justify-between mb-6">
            <button onclick="goBack()" class="glass-card p-3 rounded-xl hover:bg-white/80 transition">
                <i class="fas fa-arrow-left text-xl text-gray-700"></i>
            </button>
            
            <div class="flex gap-2">
                <button onclick="window.location.href='index.html'" class="glass-card p-3 rounded-xl hover:bg-white/80 transition">
                    <i class="fas fa-home text-xl text-gray-700"></i>
                </button>
                <button onclick="openReportModal()" class="glass-card p-3 rounded-xl hover:bg-white/80 transition">
                    <i class="fas fa-flag text-xl text-gray-700"></i>
                </button>
            </div>
        </div>

        <!-- ìƒí’ˆ ìƒì„¸ ì¹´ë“œ -->
        <div class="glass-card rounded-2xl overflow-hidden mb-4">
            <!-- ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” -->
            <div class="image-slider-container">
                <div id="imageSlider"></div>
                <button id="prevBtn" class="slider-btn prev" onclick="prevSlide()" style="display: none;">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button id="nextBtn" class="slider-btn next" onclick="nextSlide()" style="display: none;">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div id="indicators" class="indicators"></div>
            </div>

            <!-- ìƒí’ˆ ì •ë³´ -->
            <div class="p-6">
                <!-- ì œëª© ë° ìƒíƒœ -->
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <h1 id="productTitle" class="text-2xl font-bold text-gray-900 mb-2">ë¡œë”©ì¤‘...</h1>
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <span id="productCategory">ì¹´í…Œê³ ë¦¬</span>
                            <span>â€¢</span>
                            <span id="productDate">ë‚ ì§œ</span>
                        </div>
                    </div>
                    <span id="statusBadge" class="px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800">íŒë§¤ì¤‘</span>
                </div>

                <!-- ê°€ê²© -->
                <div class="bg-green-50 rounded-xl p-4 mb-4">
                    <p id="productPrice" class="text-2xl font-bold text-gray-900">0ì›</p>
                    <p id="priceInfo" class="text-sm text-gray-600 mt-1">ê°€ê²© í˜‘ì˜ ê°€ëŠ¥</p>
                </div>

                <!-- ìƒí’ˆ ì„¤ëª… -->
                <div class="mb-6">
                    <h3 class="font-bold text-gray-800 mb-2">ìƒí’ˆ ì„¤ëª…</h3>
                    <p id="productDescription" class="text-gray-700 whitespace-pre-wrap leading-relaxed">ì„¤ëª… ë¡œë”©ì¤‘...</p>
                </div>

                <!-- ìƒí’ˆ í†µê³„ -->
                <div class="flex items-center gap-6 text-sm text-gray-600 mb-6">
                    <div class="flex items-center gap-1">
                        <i class="fas fa-eye"></i>
                        <span id="viewCount">0</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <i class="fas fa-heart"></i>
                        <span id="likeCount">0</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <i class="fas fa-comment"></i>
                        <span id="chatCount">0</span>
                    </div>
                </div>

                <!-- íŒë§¤ì ì •ë³´ -->
                <div class="border-t pt-4">
                    <h3 class="font-bold text-gray-800 mb-3">íŒë§¤ì ì •ë³´</h3>
                    <div class="flex items-center gap-3">
                        <img id="sellerAvatar" src="https://via.placeholder.com/50?text=?" alt="íŒë§¤ì" 
                             class="w-12 h-12 rounded-full object-cover border-2 border-gray-200">
                        <div>
                            <p id="sellerName" class="font-bold text-gray-900">ë¡œë”©ì¤‘...</p>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                <span id="productLocation">ìœ„ì¹˜</span>
                            </p>
                            <p class="text-xs text-gray-500">
                                ê°€ì…ì¼: <span id="sellerJoinDate">-</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê±°ë˜ í¬ë§ ì¥ì†Œ (ì§€ë„) -->
        <div id="mapContainer" class="hidden glass-card rounded-2xl p-6 mb-4">
            <h3 class="font-bold text-lg text-gray-800 mb-3">
                <i class="fas fa-map-marker-alt text-green-600 mr-2"></i>ê±°ë˜ í¬ë§ ì¥ì†Œ
            </h3>
            <div id="tradeMap"></div>
        </div>

        <!-- íŒë§¤ìì˜ ë‹¤ë¥¸ ìƒí’ˆ -->
        <div class="glass-card rounded-2xl p-6 mb-4">
            <h3 class="font-bold text-lg text-gray-800 mb-4">
                <i class="fas fa-store text-purple-600 mr-2"></i>íŒë§¤ìì˜ ë‹¤ë¥¸ ìƒí’ˆ
            </h3>
            <div id="sellerOtherProducts" class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <p class="col-span-full text-center text-gray-500">ë¡œë”© ì¤‘...</p>
            </div>
        </div>

        <!-- í•¨ê»˜ ë³¸ ìƒí’ˆ (ì¶”ì²œ) -->
        <div class="glass-card rounded-2xl p-6 mb-4">
            <h3 class="font-bold text-lg text-gray-800 mb-4">
                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>ì´ëŸ° ìƒí’ˆì€ ì–´ë•Œìš”?
            </h3>
            <div id="similarProducts" class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <p class="col-span-full text-center text-gray-500">ë¡œë”© ì¤‘...</p>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ê³ ì • ë°” -->
    <div class="floating-bottom">
        <div class="container mx-auto max-w-4xl">
            <!-- êµ¬ë§¤ì ì•¡ì…˜ -->
            <div id="buyerActions" class="flex items-center gap-3">
                <button id="likeBtn" onclick="toggleLike()" class="p-3 border border-gray-200 rounded-xl hover:bg-gray-50 transition">
                    <i id="likeIcon" class="far fa-heart text-gray-600 text-xl"></i>
                </button>
                <button id="actionBtn" onclick="handleChatClick()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold transition">
                    ì±„íŒ…í•˜ê¸°
                </button>
            </div>
            
            <!-- íŒë§¤ì ì•¡ì…˜ (ë³¸ì¸ ìƒí’ˆì¼ ë•Œë§Œ í‘œì‹œ) -->
            <div id="ownerActions" class="hidden space-y-3">
                <div class="flex items-center gap-3">
                    <button onclick="openStatusModal()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-xl font-medium transition">
                        <i class="fas fa-sync-alt mr-2"></i>ìƒíƒœ ë³€ê²½
                    </button>
                    <button onclick="editProduct()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-xl font-medium transition">
                        <i class="fas fa-edit mr-2"></i>ìˆ˜ì •
                    </button>
                    <button onclick="deleteProduct()" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-xl font-medium transition">
                        <i class="fas fa-trash mr-2"></i>ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ -->
    <div id="statusModal" class="modal hidden" onclick="if(event.target === this) closeStatusModal()">
        <div class="modal-content p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">ê±°ë˜ ìƒíƒœ ë³€ê²½</h3>
                <button onclick="closeStatusModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-3">
                <button onclick="changeStatus('íŒë§¤ì¤‘')" class="w-full p-4 bg-blue-50 hover:bg-blue-100 rounded-xl text-left transition">
                    <span class="font-bold text-blue-600">íŒë§¤ì¤‘</span>
                    <p class="text-sm text-gray-600 mt-1">íŒë§¤ ê°€ëŠ¥í•œ ìƒíƒœë¡œ ë³€ê²½</p>
                </button>
                <button onclick="changeStatus('ì˜ˆì•½ì¤‘')" class="w-full p-4 bg-orange-50 hover:bg-orange-100 rounded-xl text-left transition">
                    <span class="font-bold text-orange-600">ì˜ˆì•½ì¤‘</span>
                    <p class="text-sm text-gray-600 mt-1">êµ¬ë§¤ìì™€ ê±°ë˜ ì˜ˆì•½ë¨</p>
                </button>
                <button onclick="changeStatus('íŒë§¤ì™„ë£Œ')" class="w-full p-4 bg-red-50 hover:bg-red-100 rounded-xl text-left transition">
                    <span class="font-bold text-red-600">íŒë§¤ì™„ë£Œ</span>
                    <p class="text-sm text-gray-600 mt-1">ê±°ë˜ê°€ ì™„ë£Œë¨</p>
                </button>
            </div>
        </div>
    </div>

    <!-- ì‹ ê³  ëª¨ë‹¬ -->
    <div id="reportModal" class="modal hidden" onclick="if(event.target === this) closeReportModal()">
        <div class="modal-content p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-flag text-red-600 mr-2"></i>ì‹ ê³ í•˜ê¸°
                </h3>
                <button onclick="closeReportModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2">ì‹ ê³  ì‚¬ìœ </label>
                    <select id="reportReason" class="w-full p-3 border border-gray-200 rounded-xl">
                        <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                        <option value="ì‚¬ê¸° ì˜ì‹¬">ì‚¬ê¸° ì˜ì‹¬</option>
                        <option value="ì „ë¬¸ íŒë§¤ì—…ì">ì „ë¬¸ íŒë§¤ì—…ì</option>
                        <option value="ë¶€ì ì ˆí•œ ê²Œì‹œê¸€">ë¶€ì ì ˆí•œ ê²Œì‹œê¸€</option>
                        <option value="ê±°ë˜ ê¸ˆì§€ í’ˆëª©">ê±°ë˜ ê¸ˆì§€ í’ˆëª©</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2">ìƒì„¸ ë‚´ìš©</label>
                    <textarea id="reportDetails" rows="4" placeholder="ì‹ ê³  ì‚¬ìœ ë¥¼ ìƒì„¸íˆ ì…ë ¥í•´ì£¼ì„¸ìš”" 
                              class="w-full p-3 border border-gray-200 rounded-xl resize-none"></textarea>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        í—ˆìœ„ ì‹ ê³  ì‹œ ì„œë¹„ìŠ¤ ì´ìš©ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    </p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="closeReportModal()" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl hover:bg-gray-200 transition">
                        ì·¨ì†Œ
                    </button>
                    <button onclick="submitReport()" class="flex-1 bg-red-600 text-white py-3 rounded-xl hover:bg-red-700 transition">
                        ì‹ ê³ í•˜ê¸°
                    </button>
                </div>
                
                <button onclick="blockUser()" class="w-full mt-2 text-sm text-gray-600 hover:text-gray-800 underline">
                    ì´ ì‚¬ìš©ìì˜ ê²Œì‹œê¸€ ë³´ì§€ ì•Šê¸°
                </button>
            </div>
        </div>
    </div>

</body>
</html>
