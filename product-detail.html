<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ë¬¼ ìƒì„¸ ì •ë³´ - PlantiaWorld</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
       <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
       <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
       <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background: linear-gradient(135deg, #f8fdf8 0%, #e8f5e9 100%);
            min-height: 100vh;
        }
        .slider-container { 
            position: relative; 
            overflow: hidden; 
            background: #f3f4f6; 
            aspect-ratio: 1 / 1; 
            max-height: 70vh;
        }
        .slider-wrapper { 
            display: flex; 
            transition: transform 0.3s ease-out; 
            height: 100%; 
        }
        .slider-item { 
            min-width: 100%; 
            height: 100%; 
            object-fit: cover;
            background-color: #e5e7eb;
        }
        .indicator { 
            position: absolute; 
            bottom: 16px; 
            left: 50%; 
            transform: translateX(-50%); 
            display: flex; 
            gap: 8px; 
            z-index: 10;
        }
        .dot { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.5); 
            transition: 0.3s; 
            cursor: pointer;
        }
        .dot.active { 
            background: #fff; 
            width: 20px; 
            border-radius: 4px; 
        }
        .floating-bottom { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: white; 
            border-top: 1px solid #e5e7eb; 
            padding: 16px; 
            z-index: 50; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-sold { background: #dc2626; color: white; }
        .badge-free { background: #10b981; color: white; }
        .badge-reserved { background: #f59e0b; color: white; }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .seller-info {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .product-status {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }
    </style>
</head>
<body class="pb-24">

    <!-- í—¤ë” -->
    <header class="fixed top-0 left-0 right-0 z-50 flex justify-between p-4 items-center bg-white/80 backdrop-blur-sm">
        <button onclick="goBack()" class="w-10 h-10 bg-white/90 backdrop-blur rounded-full shadow flex items-center justify-center hover:bg-gray-50 transition">
            <i class="fas fa-arrow-left text-gray-800"></i>
        </button>
        <div class="flex gap-2">
            <button onclick="shareLink()" class="w-10 h-10 bg-white/90 backdrop-blur rounded-full shadow flex items-center justify-center hover:bg-gray-50 transition">
                <i class="fas fa-share-alt text-gray-800"></i>
            </button>
            <button onclick="toggleLike()" class="w-10 h-10 bg-white/90 backdrop-blur rounded-full shadow flex items-center justify-center hover:bg-gray-50 transition">
                <i id="likeIcon" class="far fa-heart text-gray-800"></i>
            </button>
        </div>
    </header>

    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p class="text-gray-500">ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main id="content" class="hidden">
        <!-- ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” -->
        <div class="slider-container">
            <div id="sliderWrapper" class="slider-wrapper"></div>
            <div id="sliderIndicator" class="indicator"></div>
            
            <!-- ìƒí’ˆ ìƒíƒœ ë°°ì§€ -->
            <div id="productStatus" class="product-status"></div>
        </div>

        <!-- íŒë§¤ì ì •ë³´ -->
        <div class="seller-info">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div id="sellerAvatar" class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                        <i class="fas fa-user text-xl"></i>
                    </div>
                    <div>
                        <h3 id="sellerName" class="font-bold text-gray-800">ì´ˆë¡ì´ì›ƒ</h3>
                        <p id="productLocation" class="text-xs text-gray-500"></p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="inline-block px-3 py-1 bg-green-50 text-green-600 rounded-full text-xs font-bold">ë§¤ë„ˆì˜¨ë„ 37.5Â°C</span>
                    <p class="text-xs text-gray-400 mt-1">1ì‹œê°„ ë‚´ ì‘ë‹µ</p>
                </div>
            </div>
            <hr class="border-gray-100 my-4">
            
            <!-- ìƒí’ˆ ì •ë³´ -->
            <div class="mb-6">
                <h2 id="productTitle" class="text-2xl font-bold text-gray-900 mb-2"></h2>
                <div class="flex gap-2 text-sm text-gray-400 mb-4">
                    <span id="productCategory" class="bg-green-50 text-green-600 px-2 py-1 rounded-full"></span>
                    <span>â€¢</span>
                    <span id="productDate" class="text-gray-400"></span>
                </div>
                
                <div class="mb-6">
                    <p id="productDescription" class="text-gray-700 leading-relaxed whitespace-pre-wrap"></p>
                </div>
                
                <!-- ì¶”ê°€ ì •ë³´ -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">ê±°ë˜í¬ë§ì¥ì†Œ</p>
                        <p id="tradeLocation" class="font-medium">ë¬¸ì˜</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-xs text-gray-500 mb-1">ìƒíƒœ</p>
                        <p id="productCondition" class="font-medium">ì¢‹ìŒ</p>
                    </div>
                </div>
                
                <!-- ì¡°íšŒìˆ˜ & ì¢‹ì•„ìš” -->
                <div class="flex gap-4 text-sm text-gray-400">
                    <span><i class="far fa-eye mr-1"></i><span id="viewCount">12</span> ì¡°íšŒ</span>
                    <span>â€¢</span>
                    <span><i class="far fa-heart mr-1"></i><span id="likeCount">0</span> ê´€ì‹¬</span>
                </div>
            </div>
        </div>
        
        <!-- ìƒí’ˆ ID (ë””ë²„ê¹…ìš©) -->
        <div class="px-5 text-xs text-gray-400 text-center mt-4">
            ìƒí’ˆ ID: <span id="debugProductId"></span>
        </div>
    </main>

    <!-- í•˜ë‹¨ ê³ ì • ë°” -->
    <div class="floating-bottom">
        <div class="max-w-2xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div>
                    <p id="productPrice" class="text-xl font-bold text-gray-900"></p>
                    <p id="priceInfo" class="text-xs text-green-600 font-bold"></p>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="actionBtn" onclick="handleAction()" 
                        class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition whitespace-nowrap">
                    ì±„íŒ…í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== Firebase ì´ˆê¸°í™” ==========
        const firebaseConfig = {
            apiKey: "AIzaSyA8W_2h3oI9S21-hoXKYBKs7rbdo86n6dc",
            authDomain: "plantiaworld.firebaseapp.com",
            projectId: "plantiaworld",
            storageBucket: "plantiaworld.firebasestorage.app",
            messagingSenderId: "18112813073",
            appId: "1:18112813073:web:7247046c038a3831db79b",
            measurementId: "G-8XSZM279KY"
        };

        let db, auth;
        let currentProduct = null;
        let unsubscribeProduct = null;
        
        // ========== í˜ì´ì§€ ì´ˆê¸°í™” ==========
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ìƒì„¸ í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
            
            try {
                // Firebase ì´ˆê¸°í™”
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                db = firebase.firestore();
                auth = firebase.auth();
                
                // URLì—ì„œ productId ê°€ì ¸ì˜¤ê¸°
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('id');
                
                if (!productId) {
                    alert('ìƒí’ˆ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    location.href = 'index.html';
                    return;
                }
                
                document.getElementById('debugProductId').textContent = productId;
                
                // Firestoreì—ì„œ ìƒí’ˆ ë°ì´í„° ë¡œë“œ
                await loadProductFromFirestore(productId);
                
                // ì¡°íšŒìˆ˜ ì¦ê°€
                await incrementViewCount(productId);
                
                // ë¡œë”© ìˆ¨ê¸°ê¸°
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                
            } catch (error) {
                console.error('í˜ì´ì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
                fallbackToLocalStorage();
            }
        });
        
        // ========== Firestoreì—ì„œ ìƒí’ˆ ë¡œë“œ ==========
        async function loadProductFromFirestore(productId) {
            try {
                console.log('Firestoreì—ì„œ ìƒí’ˆ ë¡œë“œ:', productId);
                
                // Firestore ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                unsubscribeProduct = db.collection('products').doc(productId)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const product = doc.data();
                            product.id = doc.id;
                            currentProduct = product;
                            
                            console.log('ìƒí’ˆ ë°ì´í„°:', product);
                            updateProductUI(product);
                            
                            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ì˜¤í”„ë¼ì¸ìš©)
                            saveToLocalStorage(product);
                        } else {
                            console.log('ìƒí’ˆì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
                            showProductNotFound();
                        }
                    }, (error) => {
                        console.error('Firestore ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
                        fallbackToLocalStorage();
                    });
                    
            } catch (error) {
                console.error('Firestore ë¡œë“œ ì˜¤ë¥˜:', error);
                fallbackToLocalStorage();
            }
        }
        
        // ========== UI ì—…ë°ì´íŠ¸ ==========
        function updateProductUI(product) {
            // ê¸°ë³¸ ì •ë³´
            document.getElementById('productTitle').textContent = product.title || 'ì œëª© ì—†ìŒ';
            document.getElementById('productCategory').textContent = product.category || 'ê¸°íƒ€';
            document.getElementById('productDescription').textContent = product.description || 'ìƒí’ˆ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
            
            // ìœ„ì¹˜ ì •ë³´
            const location = product.sellerLocation || product.location || 'ì§€ì—­ ì •ë³´ ì—†ìŒ';
            document.getElementById('productLocation').textContent = location;
            document.getElementById('tradeLocation').textContent = location;
            
            // ë‚ ì§œ ì •ë³´
            const date = formatDate(product.createdAt || product.createdDate);
            document.getElementById('productDate').textContent = date;
            
            // ê°€ê²© ì •ë³´
            const price = product.price || 0;
            const priceElement = document.getElementById('productPrice');
            const priceInfoElement = document.getElementById('priceInfo');
            
            if (price === 0) {
                priceElement.textContent = 'ë‚˜ëˆ” ğŸŒ±';
                priceElement.className = 'text-xl font-bold text-green-600';
                priceInfoElement.textContent = 'ë¬´ë£Œ ë‚˜ëˆ”';
            } else {
                priceElement.textContent = price.toLocaleString() + 'ì›';
                priceElement.className = 'text-xl font-bold text-gray-900';
                priceInfoElement.textContent = 'ê°€ê²© ì œì•ˆ ë¶ˆê°€';
            }
            
            // ìƒíƒœ ì •ë³´
            const statusElement = document.getElementById('productStatus');
            const status = product.status || 'íŒë§¤ì¤‘';
            
            statusElement.innerHTML = '';
            if (status === 'íŒë§¤ì™„ë£Œ') {
                statusElement.innerHTML = '<span class="badge badge-sold">íŒë§¤ì™„ë£Œ</span>';
                document.getElementById('actionBtn').textContent = 'íŒë§¤ì™„ë£Œ';
                document.getElementById('actionBtn').className = 'bg-gray-400 text-white px-6 py-3 rounded-xl font-bold cursor-not-allowed';
                document.getElementById('actionBtn').onclick = null;
            } else if (status === 'ì˜ˆì•½ì¤‘') {
                statusElement.innerHTML = '<span class="badge badge-reserved">ì˜ˆì•½ì¤‘</span>';
                document.getElementById('actionBtn').textContent = 'ì˜ˆì•½ ë¬¸ì˜';
            } else if (price === 0) {
                statusElement.innerHTML = '<span class="badge badge-free">ë¬´ë£Œë‚˜ëˆ”</span>';
                document.getElementById('actionBtn').textContent = 'ë‚˜ëˆ” ë¬¸ì˜';
            }
            
            // ì¢‹ì•„ìš” ìˆ˜
            const likes = product.likes || 0;
            document.getElementById('likeCount').textContent = likes;
            
            // íŒë§¤ì ì •ë³´
            document.getElementById('sellerName').textContent = product.sellerName || 'ì´ˆë¡ì´ì›ƒ';
            
            // ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë”
            updateImageSlider(product);
            
            // ë‚´ê°€ ì¢‹ì•„ìš” í–ˆëŠ”ì§€ í™•ì¸
            checkIfLiked(product.id);
        }
        
        // ========== ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸ ==========
        function updateImageSlider(product) {
            const wrapper = document.getElementById('sliderWrapper');
            const indicator = document.getElementById('sliderIndicator');
            
            wrapper.innerHTML = '';
            indicator.innerHTML = '';
            
            // ì´ë¯¸ì§€ ë°°ì—´ í™•ì¸
            const images = product.images || [];
            let imageUrls = [];
            
            if (images.length > 0) {
                imageUrls = images;
            } else {
                // ê¸°ë³¸ ì´ë¯¸ì§€ ìƒì„±
                imageUrls = [
                    `https://images.unsplash.com/photo-1416879595882-3373a0480b5b?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80&text=${encodeURIComponent(product.title || 'ì‹ë¬¼')}`
                ];
            }
            
            // ì´ë¯¸ì§€ ì¶”ê°€
            imageUrls.forEach((imgSrc, idx) => {
                const img = document.createElement('img');
                img.src = imgSrc;
                img.className = 'slider-item';
                img.alt = product.title || 'ì‹ë¬¼ ì´ë¯¸ì§€';
                img.onerror = function() {
                    this.src = 'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80';
                };
                wrapper.appendChild(img);
                
                const dot = document.createElement('div');
                dot.className = `dot ${idx === 0 ? 'active' : ''}`;
                dot.onclick = () => goToSlide(idx);
                indicator.appendChild(dot);
            });
            
            // ìë™ ìŠ¬ë¼ì´ë“œ ì„¤ì • (ì´ë¯¸ì§€ê°€ 2ê°œ ì´ìƒì¼ ë•Œ)
            if (imageUrls.length > 1) {
                startAutoSlide();
            }
        }
        
        // ========== ìŠ¬ë¼ì´ë“œ ê¸°ëŠ¥ ==========
        let currentSlide = 0;
        let slideInterval = null;
        
        function goToSlide(index) {
            const wrapper = document.getElementById('sliderWrapper');
            const dots = document.querySelectorAll('.dot');
            
            currentSlide = index;
            wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
            
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === currentSlide);
            });
        }
        
        function startAutoSlide() {
            if (slideInterval) clearInterval(slideInterval);
            
            slideInterval = setInterval(() => {
                const dots = document.querySelectorAll('.dot');
                currentSlide = (currentSlide + 1) % dots.length;
                goToSlide(currentSlide);
            }, 4000);
        }
        
        // ========== ì¢‹ì•„ìš” ê¸°ëŠ¥ ==========
        async function toggleLike() {
            const user = auth.currentUser;
            if (!user) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = 'login.html?returnUrl=' + encodeURIComponent(window.location.href);
                return;
            }
            
            const productId = currentProduct.id;
            const userId = user.uid;
            const likeRef = db.collection('likes').doc(`${userId}_${productId}`);
            
            try {
                const likeDoc = await likeRef.get();
                const productRef = db.collection('products').doc(productId);
                
                if (likeDoc.exists) {
                    // ì¢‹ì•„ìš” ì·¨ì†Œ
                    await likeRef.delete();
                    await productRef.update({
                        likes: firebase.firestore.FieldValue.increment(-1)
                    });
                    
                    document.getElementById('likeIcon').className = 'far fa-heart text-gray-800';
                } else {
                    // ì¢‹ì•„ìš” ì¶”ê°€
                    await likeRef.set({
                        userId: userId,
                        productId: productId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    await productRef.update({
                        likes: firebase.firestore.FieldValue.increment(1)
                    });
                    
                    document.getElementById('likeIcon').className = 'fas fa-heart text-red-500';
                }
            } catch (error) {
                console.error('ì¢‹ì•„ìš” ì˜¤ë¥˜:', error);
                alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        async function checkIfLiked(productId) {
            const user = auth.currentUser;
            if (!user) return;
            
            const likeRef = db.collection('likes').doc(`${user.uid}_${productId}`);
            
            try {
                const likeDoc = await likeRef.get();
                if (likeDoc.exists) {
                    document.getElementById('likeIcon').className = 'fas fa-heart text-red-500';
                }
            } catch (error) {
                console.error('ì¢‹ì•„ìš” í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }
        
        // ========== ì¡°íšŒìˆ˜ ì¦ê°€ ==========
        async function incrementViewCount(productId) {
            try {
                const productRef = db.collection('products').doc(productId);
                await productRef.update({
                    views: firebase.firestore.FieldValue.increment(1)
                });
            } catch (error) {
                console.error('ì¡°íšŒìˆ˜ ì¦ê°€ ì˜¤ë¥˜:', error);
            }
        }
        
        // ========== ì±„íŒ…/êµ¬ë§¤ ê¸°ëŠ¥ ==========
        async function handleAction() {
            const user = auth.currentUser;
            if (!user) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = 'login.html?returnUrl=' + encodeURIComponent(window.location.href);
                return;
            }
            
            const status = currentProduct.status || 'íŒë§¤ì¤‘';
            
            if (status === 'íŒë§¤ì™„ë£Œ') {
                alert('ì´ë¯¸ íŒë§¤ ì™„ë£Œëœ ìƒí’ˆì…ë‹ˆë‹¤.');
                return;
            }
            
            // ì±„íŒ… ì‹œì‘
            alert('ì±„íŒ… ê¸°ëŠ¥ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. íŒë§¤ìì—ê²Œ ì—°ë½í•´ì£¼ì„¸ìš”.\n\n' +
                  'íŒë§¤ì: ' + (currentProduct.sellerName || 'ì´ˆë¡ì´ì›ƒ') + '\n' +
                  'ìƒí’ˆ: ' + currentProduct.title);
            
            // ì±„íŒ…ë°© ìƒì„± ë¡œì§ (êµ¬í˜„ í•„ìš”)
            // const chatRef = db.collection('chats').add({
            //     productId: currentProduct.id,
            //     buyerId: user.uid,
            //     sellerId: currentProduct.sellerId,
            //     createdAt: firebase.firestore.FieldValue.serverTimestamp()
            // });
        }
        
        // ========== ê¸°íƒ€ ê¸°ëŠ¥ ==========
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }
        
        function shareLink() {
            const url = window.location.href;
            const title = currentProduct?.title || 'PlantiaWorld ìƒí’ˆ';
            
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: 'PlantiaWorldì—ì„œ ì´ ìƒí’ˆì„ í™•ì¸í•´ë³´ì„¸ìš”!',
                    url: url,
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                });
            }
        }
        
        // ========== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ==========
        function formatDate(dateInput) {
            if (!dateInput) return 'ë°©ê¸ˆ ì „';
            
            try {
                let date;
                if (dateInput.toDate) {
                    date = dateInput.toDate();
                } else if (typeof dateInput === 'string') {
                    date = new Date(dateInput);
                } else if (dateInput instanceof Date) {
                    date = dateInput;
                } else {
                    date = new Date(dateInput);
                }
                
                const now = new Date();
                const diffInMinutes = Math.floor((now - date) / (1000 * 60));
                
                if (diffInMinutes < 1) return 'ë°©ê¸ˆ ì „';
                if (diffInMinutes < 60) return `${diffInMinutes}ë¶„ ì „`;
                if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}ì‹œê°„ ì „`;
                if (diffInMinutes < 10080) return `${Math.floor(diffInMinutes / 1440)}ì¼ ì „`;
                
                return date.toLocaleDateString('ko-KR');
            } catch (e) {
                return 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
            }
        }
        
        function fallbackToLocalStorage() {
            console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ');
            
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            const products = JSON.parse(localStorage.getItem('plantiaProducts') || '[]');
            const product = products.find(p => p.id == productId);
            
            if (product) {
                updateProductUI(product);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                
                // ìƒíƒœ í‘œì‹œ
                document.getElementById('debugProductId').textContent += ' (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)';
                showOfflineNotice();
            } else {
                showProductNotFound();
            }
        }
        
        function saveToLocalStorage(product) {
            try {
                const products = JSON.parse(localStorage.getItem('plantiaProducts') || '[]');
                const index = products.findIndex(p => p.id === product.id);
                
                if (index !== -1) {
                    products[index] = product;
                } else {
                    products.push(product);
                }
                
                localStorage.setItem('plantiaProducts', JSON.stringify(products));
            } catch (error) {
                console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }
        
        function showProductNotFound() {
            document.getElementById('loading').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-seedling text-6xl text-gray-300 mb-4"></i>
                    <h2 class="text-xl font-bold text-gray-700 mb-2">ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
                    <p class="text-gray-500 mb-6">ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìƒí’ˆì…ë‹ˆë‹¤.</p>
                    <button onclick="location.href='index.html'" 
                            class="bg-green-600 text-white px-6 py-2 rounded-full font-medium">
                        í™ˆìœ¼ë¡œ ê°€ê¸°
                    </button>
                </div>
            `;
        }
        
        function showOfflineNotice() {
            const notice = document.createElement('div');
            notice.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-4 mx-4 my-4 rounded';
            notice.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-wifi-slash text-yellow-400 mr-2"></i>
                    <p class="text-yellow-700 text-sm">
                        ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ í‘œì‹œë©ë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²° í›„ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.
                    </p>
                </div>
            `;
            
            document.querySelector('main').insertBefore(notice, document.querySelector('main').firstChild);
        }
        
        // ========== í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬ ==========
        window.addEventListener('beforeunload', () => {
            if (unsubscribeProduct) {
                unsubscribeProduct();
            }
            
            if (slideInterval) {
                clearInterval(slideInterval);
            }
        });
    </script>
</body>
</html>